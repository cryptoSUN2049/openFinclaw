<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FinClaw Evolution Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /*__EVO_CSS__*/
    </style>
  </head>
  <body>
    <!-- ── Top Bar ── -->
    <nav class="topbar">
      <span class="topbar__logo">FINCLAW</span>
      <span class="topbar__sep"></span>
      <span class="topbar__title">Evolution Engine</span>
      <span class="topbar__fill"></span>
      <div class="topbar__dot" id="sseDot" title="SSE disconnected"></div>
      <span class="topbar__clock" id="clock"></span>
    </nav>

    <!-- ── Content ── -->
    <div class="evo-content">
      <!-- Stats Row -->
      <div class="stats-grid fade-up d1" id="statsRow">
        <div class="stat-card">
          <div class="label">Active Strategies</div>
          <div class="value" id="statActive">0</div>
          <div class="sub" id="statTotal">0 total</div>
        </div>
        <div class="stat-card">
          <div class="label">Avg Fitness</div>
          <div class="value" id="statFitness">0</div>
          <div class="sub" id="statBest">best: 0</div>
        </div>
        <div class="stat-card">
          <div class="label">Mutations</div>
          <div class="value" id="statMutations">0</div>
          <div class="sub" id="statMutRate">0% success</div>
        </div>
        <div class="stat-card">
          <div class="label">Survival Rate</div>
          <div class="value" id="statSurvival">0%</div>
          <div class="sub" id="statExtinct">0 extinct</div>
        </div>
      </div>

      <!-- Pipeline -->
      <div class="panel-card fade-up d2">
        <div class="pipeline" id="pipeline">
          <div class="pipe-stage pipe-stage--l0">
            <div class="pipe-stage__label">L0 INCUBATE</div>
            <div class="pipe-stage__count" id="pipeL0">0</div>
          </div>
          <div class="pipe-stage pipe-stage--l1">
            <div class="pipe-stage__label">L1 BACKTEST</div>
            <div class="pipe-stage__count" id="pipeL1">0</div>
          </div>
          <div class="pipe-stage pipe-stage--l2">
            <div class="pipe-stage__label">L2 PAPER</div>
            <div class="pipe-stage__count" id="pipeL2">0</div>
          </div>
          <div class="pipe-stage pipe-stage--l3">
            <div class="pipe-stage__label">L3 LIVE</div>
            <div class="pipe-stage__count" id="pipeL3">0</div>
          </div>
        </div>
      </div>

      <!-- Two columns -->
      <div class="evo-columns">
        <!-- Left: Strategy Leaderboard -->
        <div class="panel-card fade-up d3">
          <div class="panel-card__head">
            <div class="panel-card__title">
              <span class="icon">&#129516;</span> Strategy Leaderboard
            </div>
          </div>
          <table class="race-table" id="nodeTable">
            <thead>
              <tr>
                <th>Strategy</th>
                <th>Gen</th>
                <th>Fitness</th>
                <th>Level</th>
                <th>Tier</th>
              </tr>
            </thead>
            <tbody id="nodeBody"></tbody>
          </table>
          <div id="noNodes" class="empty" style="display: none">No active strategies</div>
        </div>

        <!-- Right: Tier Distribution + Audit Feed -->
        <div style="display: flex; flex-direction: column; gap: 12px">
          <!-- Tier Distribution -->
          <div class="panel-card fade-up d4">
            <div class="panel-card__head">
              <div class="panel-card__title">
                <span class="icon">&#128200;</span> Survival Tiers
              </div>
            </div>
            <div class="tier-bars" id="tierBars"></div>
          </div>

          <!-- Audit Feed -->
          <div class="panel-card fade-up d5" style="flex: 1">
            <div class="panel-card__head">
              <div class="panel-card__title">
                <span class="icon">&#128220;</span> Audit Log
              </div>
            </div>
            <div class="audit-feed" id="auditFeed">
              <div id="noAudit" class="empty">No audit entries</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const DATA = /*__EVO_DATA__*/ {};

      /* ── Clock ── */
      function tickClock() {
        var el = document.getElementById("clock");
        if (el) el.textContent = new Date().toLocaleTimeString();
      }
      tickClock();
      setInterval(tickClock, 1000);

      /* ── Helpers ── */
      function levelBadge(level) {
        var short = level
          .replace("_INCUBATE", "")
          .replace("_BACKTEST", "")
          .replace("_PAPER", "")
          .replace("_LIVE", "");
        var cls =
          level === "KILLED" ? "level-badge--killed" : "level-badge--" + short.toLowerCase();
        return '<span class="level-badge ' + cls + '">' + escapeHtml(short) + "</span>";
      }

      function tierClass(tier) {
        return "tier-" + tier;
      }

      function escapeHtml(str) {
        var d = document.createElement("div");
        d.textContent = str;
        return d.innerHTML;
      }

      /* ── Stats ── */
      function updateStats(stats) {
        document.getElementById("statActive").textContent = stats.activeStrategies;
        document.getElementById("statTotal").textContent = stats.totalStrategies + " total";
        document.getElementById("statFitness").textContent = stats.avgFitness.toFixed(3);
        document.getElementById("statBest").textContent =
          "best: " + stats.bestFitness.toFixed(3);
        document.getElementById("statMutations").textContent = stats.totalMutations;
        document.getElementById("statMutRate").textContent =
          (stats.mutationSuccessRate * 100).toFixed(0) + "% success";
        document.getElementById("statSurvival").textContent =
          (stats.survivalRate * 100).toFixed(0) + "%";
        document.getElementById("statExtinct").textContent =
          stats.extinctStrategies + " extinct";

        document.getElementById("pipeL0").textContent = stats.byLevel.L0;
        document.getElementById("pipeL1").textContent = stats.byLevel.L1;
        document.getElementById("pipeL2").textContent = stats.byLevel.L2;
        document.getElementById("pipeL3").textContent = stats.byLevel.L3;
      }

      /* ── Strategy Leaderboard ── */
      function updateNodeTable(nodes) {
        var body = document.getElementById("nodeBody");
        var noNodes = document.getElementById("noNodes");
        var latest = {};
        for (var i = 0; i < nodes.length; i++) {
          var n = nodes[i];
          if (!latest[n.strategyId] || n.generation > latest[n.strategyId].generation) {
            latest[n.strategyId] = n;
          }
        }
        var sorted = Object.values(latest);
        sorted.sort(function (a, b) {
          return b.fitness - a.fitness;
        });
        sorted = sorted.filter(function (n) {
          return n.level !== "KILLED";
        });

        if (sorted.length === 0) {
          body.innerHTML = "";
          noNodes.style.display = "block";
          return;
        }
        noNodes.style.display = "none";

        var html = "";
        for (var j = 0; j < sorted.length; j++) {
          var s = sorted[j];
          var pct = Math.round(s.fitness * 100);
          html += "<tr>";
          html += '<td class="strat-name">' + escapeHtml(s.strategyName) + "</td>";
          html += "<td>" + s.generation + "</td>";
          html +=
            '<td><div class="fitness-bar"><div class="fitness-bar__fill" style="width:' +
            pct +
            '%"></div></div>' +
            s.fitness.toFixed(3) +
            "</td>";
          html += "<td>" + levelBadge(s.level) + "</td>";
          html += '<td class="' + tierClass(s.survivalTier) + '">' + s.survivalTier + "</td>";
          html += "</tr>";
        }
        body.innerHTML = html;
      }

      /* ── Tier Distribution ── */
      function updateTierBars(tiers) {
        var bars = document.getElementById("tierBars");
        var max = Math.max(
          tiers.thriving,
          tiers.healthy,
          tiers.stressed,
          tiers.critical,
          tiers.stopped,
          1,
        );
        var tierData = [
          { name: "thriving", count: tiers.thriving, color: "var(--gain)" },
          { name: "healthy", count: tiers.healthy, color: "var(--info)" },
          { name: "stressed", count: tiers.stressed, color: "var(--warn)" },
          { name: "critical", count: tiers.critical, color: "var(--loss)" },
          { name: "stopped", count: tiers.stopped, color: "var(--text-dim)" },
        ];
        var html = "";
        for (var i = 0; i < tierData.length; i++) {
          var t = tierData[i];
          var w = max > 0 ? (t.count / max) * 100 : 0;
          html += '<div class="tier-row">';
          html += '<span class="tier-name ' + tierClass(t.name) + '">' + t.name + "</span>";
          html +=
            '<div class="tier-bar"><div class="tier-bar-fill" style="width:' +
            w +
            "%;background:" +
            t.color +
            '"></div></div>';
          html += '<span class="tier-count">' + t.count + "</span>";
          html += "</div>";
        }
        bars.innerHTML = html;
      }

      /* ── Audit Feed ── */
      function updateAuditFeed(audit) {
        var feed = document.getElementById("auditFeed");
        var noAudit = document.getElementById("noAudit");
        if (!audit || audit.length === 0) {
          noAudit.style.display = "block";
          return;
        }
        noAudit.style.display = "none";

        var html = "";
        for (var i = 0; i < Math.min(audit.length, 15); i++) {
          var a = audit[i];
          var time = a.createdAt ? a.createdAt.slice(11, 19) : "";
          html += '<div class="audit-item audit-item--' + a.type + '">';
          html += '<div class="audit-item__top">';
          html +=
            '<span class="audit-type audit-type--' + a.type + '">' + a.type + "</span>";
          html += '<span class="audit-time">' + time + "</span>";
          html += "</div>";
          if (a.strategyName) {
            html += '<div class="audit-strat">' + escapeHtml(a.strategyName) + "</div>";
          }
          html += '<div class="audit-detail">' + escapeHtml(a.detail) + "</div>";
          html += "</div>";
        }
        feed.innerHTML = html;
      }

      /* ── Dashboard Update ── */
      function updateDashboard(data) {
        if (data.stats) updateStats(data.stats);
        if (data.tree && data.tree.nodes) updateNodeTable(data.tree.nodes);
        if (data.stats && data.stats.bySurvivalTier) updateTierBars(data.stats.bySurvivalTier);
        if (data.recentAudit) updateAuditFeed(data.recentAudit);
      }

      // Initial render
      updateDashboard(DATA);

      /* ── SSE Connection ── */
      function startSSE() {
        if (typeof EventSource === "undefined") return;
        var es = new EventSource("/api/v1/finance/evolution/stream");
        var dot = document.getElementById("sseDot");
        es.onopen = function () {
          dot.classList.add("connected");
          dot.title = "SSE connected";
        };
        es.onmessage = function (ev) {
          try {
            var data = JSON.parse(ev.data);
            updateDashboard(data);
          } catch (e) {
            // Ignore parse errors
          }
        };
        es.onerror = function () {
          dot.classList.remove("connected");
          dot.title = "SSE disconnected";
          es.close();
          setTimeout(startSSE, 10000);
        };
      }

      startSSE();
    </script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FinClaw Fund Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
      /*__FUND_CSS__*/
    </style>
  </head>
  <body>
    <div class="dashboard">
      <header class="dashboard-header">
        <h1><span>FinClaw</span> Fund Dashboard</h1>
        <div class="timestamp" id="timestamp"></div>
        <div class="live-badge" id="live-badge" style="display:none">LIVE</div>
      </header>

      <div class="panels">
        <!-- Panel 1: Fund Hero -->
        <div class="panel panel-full" id="panel-hero">
          <div class="fund-hero">
            <div class="equity" id="hero-equity">$0</div>
            <div class="pnl" id="hero-pnl">+$0 (+0.0%)</div>
            <div class="risk-badge" id="hero-risk">normal</div>
            <div class="mini-stats">
              <div class="mini-stat">
                <div class="label">Active Strategies</div>
                <div class="value" id="hero-active">0</div>
              </div>
              <div class="mini-stat">
                <div class="label">L3 Live</div>
                <div class="value" id="hero-l3">0</div>
              </div>
              <div class="mini-stat">
                <div class="label">Cash Reserve</div>
                <div class="value" id="hero-cash">0%</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel 2: Allocation Doughnut + Table -->
        <div class="panel">
          <div class="panel-title"><span class="icon">üíº</span> Capital Allocation</div>
          <div class="chart-container" style="height: 200px">
            <canvas id="alloc-chart"></canvas>
          </div>
          <table class="lb-table" id="alloc-table" style="margin-top: 12px">
            <thead>
              <tr>
                <th>Strategy</th>
                <th>Alloc</th>
                <th>Weight</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Panel 3: Risk Gauge -->
        <div class="panel">
          <div class="panel-title"><span class="icon">üõ°Ô∏è</span> Risk Control</div>
          <div class="gauge-container">
            <svg class="gauge-svg" viewBox="0 0 160 100">
              <path
                d="M 20 90 A 60 60 0 0 1 140 90"
                fill="none"
                stroke="#30363d"
                stroke-width="12"
                stroke-linecap="round"
              />
              <path
                id="gauge-arc"
                d="M 20 90 A 60 60 0 0 1 140 90"
                fill="none"
                stroke="#2FBF71"
                stroke-width="12"
                stroke-linecap="round"
                stroke-dasharray="0 999"
              />
              <text
                id="gauge-text"
                x="80"
                y="80"
                text-anchor="middle"
                font-size="20"
                font-weight="700"
                font-family="SF Mono, monospace"
                fill="#e6edf3"
              >
                0%
              </text>
            </svg>
            <div class="gauge-info">
              <div class="stat-row">
                <span class="stat-label">Daily DD</span
                ><span class="stat-value" id="risk-dd">0%</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Max Allowed</span
                ><span class="stat-value" id="risk-max">10%</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Exposure</span
                ><span class="stat-value" id="risk-exposure">0%</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Scale Factor</span
                ><span class="stat-value" id="risk-scale">100%</span>
              </div>
            </div>
          </div>
          <ul class="action-list" id="risk-actions"></ul>
        </div>

        <!-- Panel 4: Leaderboard Table -->
        <div class="panel panel-full">
          <div class="panel-title"><span class="icon">üìä</span> Strategy Leaderboard</div>
          <table class="lb-table" id="lb-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Strategy</th>
                <th>Level</th>
                <th>Score</th>
                <th>Fitness</th>
                <th>Sharpe</th>
                <th>MaxDD</th>
                <th>Trades</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div
            id="lb-empty"
            style="
              display: none;
              text-align: center;
              padding: 24px;
              color: var(--fc-text-secondary);
            "
          >
            No eligible strategies found. Register strategies and run a rebalance.
          </div>
        </div>
      </div>

      <footer class="dashboard-footer">Generated by OpenFinClaw Fund Manager</footer>
    </div>

    <script>
      (function () {
        var DATA = /*__FUND_DATA__*/ {};
        var allocChart = null;

        function fmt(n) {
          return (n || 0).toLocaleString("en-US", { maximumFractionDigits: 2 });
        }
        function signed(n) {
          return (n >= 0 ? "+" : "") + fmt(n);
        }

        function getDefaultActions(level) {
          switch (level) {
            case "critical":
              return ["HALT all trading immediately", "Notify user", "Close risky positions"];
            case "warning":
              return ["Shrink all positions by 50%", "No new entries", "Monitor closely"];
            case "caution":
              return ["Reduce new position sizes by 20%", "Tighten stop losses"];
            default:
              return ["Normal operations"];
          }
        }

        function updateDashboard(data) {
          DATA = data;
          document.getElementById("timestamp").textContent = new Date().toLocaleString();

          // ‚îÄ‚îÄ Panel 1: Hero ‚îÄ‚îÄ
          var s = data.status || {};
          document.getElementById("hero-equity").textContent = "$" + fmt(s.totalEquity || 0);

          var pnlEl = document.getElementById("hero-pnl");
          var pnl = s.todayPnl || 0;
          var pnlPct = s.todayPnlPct || 0;
          pnlEl.textContent = signed(pnl) + " (" + signed(pnlPct) + "%)";
          pnlEl.className = "pnl " + (pnl >= 0 ? "pnl-positive" : "pnl-negative");

          var riskEl = document.getElementById("hero-risk");
          riskEl.textContent = (s.riskLevel || "normal").toUpperCase();
          riskEl.className = "risk-badge risk-" + (s.riskLevel || "normal");

          var byLevel = s.byLevel || {};
          var active =
            (byLevel.L3_LIVE || 0) + (byLevel.L2_PAPER || 0) + (byLevel.L1_BACKTEST || 0);
          document.getElementById("hero-active").textContent = active;
          document.getElementById("hero-l3").textContent = byLevel.L3_LIVE || 0;

          var alloc = data.allocations || {};
          var cashPct =
            alloc.totalCapital > 0
              ? (((alloc.cashReserve || 0) / alloc.totalCapital) * 100).toFixed(1)
              : "0";
          document.getElementById("hero-cash").textContent = cashPct + "%";

          // ‚îÄ‚îÄ Panel 2: Allocation Table + Doughnut ‚îÄ‚îÄ
          var items = alloc.items || [];
          var tbody = document.querySelector("#alloc-table tbody");
          tbody.innerHTML = "";
          for (var i = 0; i < items.length; i++) {
            var a = items[i];
            var tr = document.createElement("tr");
            var td1 = document.createElement("td");
            td1.textContent = a.strategyId;
            var td2 = document.createElement("td");
            td2.textContent = "$" + fmt(a.capitalUsd);
            var td3 = document.createElement("td");
            td3.textContent = a.weightPct.toFixed(1) + "%";
            tr.append(td1, td2, td3);
            tbody.appendChild(tr);
          }

          // Doughnut chart
          if (typeof Chart !== "undefined") {
            var colors = [
              "#FF5A2D",
              "#4A9EFF",
              "#2FBF71",
              "#FFB020",
              "#E23D2D",
              "#8B7F77",
              "#FF7A50",
            ];
            var labels = items.map(function (a) {
              return a.strategyId;
            });
            var values = items.map(function (a) {
              return a.capitalUsd;
            });
            if (alloc.cashReserve > 0) {
              labels.push("Cash Reserve");
              values.push(alloc.cashReserve);
              colors.push("#30363d");
            }

            if (allocChart) {
              allocChart.data.labels = labels;
              allocChart.data.datasets[0].data = values;
              allocChart.data.datasets[0].backgroundColor = colors.slice(0, labels.length);
              allocChart.update("none");
            } else {
              try {
                var ctx = document.getElementById("alloc-chart");
                allocChart = new Chart(ctx, {
                  type: "doughnut",
                  data: {
                    labels: labels,
                    datasets: [
                      {
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderColor: "#161b22",
                        borderWidth: 2,
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: "right",
                        labels: { color: "#8b949e", font: { size: 11 } },
                      },
                    },
                  },
                });
              } catch (e) {
                console.warn("Chart.js unavailable:", e);
              }
            }
          }

          // ‚îÄ‚îÄ Panel 3: Risk Gauge ‚îÄ‚îÄ
          var risk = data.risk || {};
          var dd = risk.dailyDrawdown || 0;
          var maxDD = risk.maxAllowedDrawdown || 10;
          var arcLen = 188.5;
          var ratio = Math.min(dd / maxDD, 1);
          var gaugeArc = document.getElementById("gauge-arc");
          gaugeArc.setAttribute("stroke-dasharray", ratio * arcLen + " " + arcLen);
          var riskColors = {
            normal: "#2FBF71",
            caution: "#FFB020",
            warning: "#FF5A2D",
            critical: "#E23D2D",
          };
          gaugeArc.setAttribute("stroke", riskColors[risk.riskLevel] || "#2FBF71");
          document.getElementById("gauge-text").textContent = dd.toFixed(1) + "%";
          document.getElementById("risk-dd").textContent = "-" + dd.toFixed(1) + "%";
          document.getElementById("risk-max").textContent = maxDD + "%";
          document.getElementById("risk-exposure").textContent =
            (risk.exposurePct || 0).toFixed(1) + "%";
          document.getElementById("risk-scale").textContent =
            ((risk.scaleFactor || 1) * 100).toFixed(0) + "%";

          var actions = risk.actions || getDefaultActions(risk.riskLevel);
          var actionList = document.getElementById("risk-actions");
          actionList.innerHTML = "";
          for (var j = 0; j < actions.length; j++) {
            var li = document.createElement("li");
            li.textContent = actions[j];
            actionList.appendChild(li);
          }

          // ‚îÄ‚îÄ Panel 4: Leaderboard ‚îÄ‚îÄ
          var lb = data.leaderboard || [];
          var lbTbody = document.querySelector("#lb-table tbody");
          var lbEmpty = document.getElementById("lb-empty");
          lbTbody.innerHTML = "";

          if (lb.length === 0) {
            lbEmpty.style.display = "block";
            document.getElementById("lb-table").style.display = "none";
          } else {
            lbEmpty.style.display = "none";
            document.getElementById("lb-table").style.display = "";
            for (var k = 0; k < lb.length; k++) {
              var e = lb[k];
              var tr2 = document.createElement("tr");
              var lvlShort = e.level.replace("_", "").slice(0, 3);
              var lvlClass = "level-" + e.level.split("_")[0];
              var sharpeClass =
                e.sharpe >= 1 ? "sharpe-good" : e.sharpe >= 0 ? "sharpe-ok" : "sharpe-bad";

              var tdRank = document.createElement("td");
              tdRank.textContent = String(e.rank);
              var tdName = document.createElement("td");
              tdName.textContent = e.strategyName;
              var tdLevel = document.createElement("td");
              var lvlSpan = document.createElement("span");
              lvlSpan.className = "level-badge " + lvlClass;
              lvlSpan.textContent = lvlShort;
              tdLevel.appendChild(lvlSpan);
              var tdScore = document.createElement("td");
              tdScore.textContent = e.leaderboardScore.toFixed(3);
              var tdFit = document.createElement("td");
              tdFit.textContent = e.fitness.toFixed(3);
              var tdSharpe = document.createElement("td");
              tdSharpe.className = sharpeClass;
              tdSharpe.textContent = e.sharpe.toFixed(2);
              var tdDD2 = document.createElement("td");
              tdDD2.textContent = e.maxDrawdown.toFixed(1) + "%";
              var tdTrades = document.createElement("td");
              tdTrades.textContent = String(e.totalTrades);
              tr2.append(tdRank, tdName, tdLevel, tdScore, tdFit, tdSharpe, tdDD2, tdTrades);
              lbTbody.appendChild(tr2);
            }
          }
        }

        function startSSE() {
          var badge = document.getElementById("live-badge");
          var es = new EventSource("/api/v1/fund/stream");
          es.onmessage = function (ev) {
            try {
              var parsed = JSON.parse(ev.data);
              updateDashboard(parsed);
              if (badge) badge.style.display = "";
            } catch (err) {
              console.warn("SSE parse error:", err);
            }
          };
          es.onerror = function () {
            if (badge) badge.style.display = "none";
            es.close();
            startPolling();
          };
        }

        function startPolling() {
          setInterval(function () {
            fetch("/api/v1/fund/status")
              .then(function (r) {
                return r.json();
              })
              .then(function (statusData) {
                updateDashboard({
                  status: statusData,
                  leaderboard: DATA.leaderboard,
                  allocations: DATA.allocations,
                  risk: DATA.risk,
                });
              })
              .catch(function () {});
          }, 30000);
        }

        // Initial render
        updateDashboard(DATA);

        // Start SSE
        if (typeof EventSource !== "undefined") {
          startSSE();
        } else {
          startPolling();
        }
      })();
    </script>
  </body>
</html>

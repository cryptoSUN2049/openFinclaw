<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenFinClaw Trading Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
      /*__TRADING_CSS__*/
    </style>
  </head>
  <body>
    <div class="dashboard">
      <header class="dashboard-header">
        <h1><span>OpenFinClaw</span> Trading</h1>
        <div class="header-right">
          <div class="live-badge">
            <div class="live-dot"></div>
            LIVE
          </div>
          <div class="timestamp" id="timestamp"></div>
        </div>
      </header>

      <div class="panels">
        <!-- Panel 1: Hero Overview -->
        <div class="panel panel-full" id="panel-hero">
          <div class="trading-hero">
            <div class="hero-primary">
              <div class="equity-label">Total Equity</div>
              <div class="equity" id="hero-equity">$0.00</div>
              <div class="pnl" id="hero-pnl">+$0.00 (+0.00%)</div>
            </div>
            <div class="hero-metrics">
              <div class="metric-card">
                <div class="metric-value" id="hero-positions">0</div>
                <div class="metric-label">Positions</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="hero-strategies">0</div>
                <div class="metric-label">Strategies</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="hero-win-rate">--</div>
                <div class="metric-label">Win Rate</div>
              </div>
              <div class="metric-card">
                <div class="metric-value" id="hero-sharpe">--</div>
                <div class="metric-label">Sharpe</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Panel 2: Equity Curve -->
        <div class="panel panel-two-thirds">
          <div class="panel-title">Equity Curve</div>
          <div class="chart-container" id="equity-chart-container">
            <canvas id="equity-chart"></canvas>
          </div>
        </div>

        <!-- Panel 3: Allocation Doughnut -->
        <div class="panel panel-third">
          <div class="panel-title">Capital Allocation</div>
          <div class="chart-container" style="height: 220px">
            <canvas id="alloc-chart"></canvas>
          </div>
          <div class="alloc-legend" id="alloc-legend"></div>
        </div>

        <!-- Panel 4: Open Positions -->
        <div class="panel panel-full">
          <div class="panel-title">Open Positions</div>
          <div id="positions-content">
            <div class="table-scroll">
              <table class="data-table" id="positions-table">
                <thead>
                  <tr>
                    <th>Symbol</th>
                    <th>Side</th>
                    <th class="right">Quantity</th>
                    <th class="right">Entry Price</th>
                    <th class="right">Current Price</th>
                    <th class="right">Unrealized P&L</th>
                    <th class="right">P&L %</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="empty-state" id="positions-empty" style="display: none">
              <div class="empty-state-icon">-</div>
              No open positions
            </div>
          </div>
        </div>

        <!-- Panel 5: Strategy Performance Cards -->
        <div class="panel panel-full">
          <div class="panel-title">Strategy Performance</div>
          <div class="strategy-grid" id="strategy-grid"></div>
          <div class="empty-state" id="strategies-empty" style="display: none">
            <div class="empty-state-icon">-</div>
            No strategies registered
          </div>
        </div>

        <!-- Panel 6: Recent Orders -->
        <div class="panel panel-full">
          <div class="panel-title">Recent Orders</div>
          <div class="table-scroll">
            <table class="data-table" id="orders-table">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th class="right">Qty</th>
                  <th class="right">Price</th>
                  <th>Status</th>
                  <th class="right">Commission</th>
                  <th>Strategy</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="empty-state" id="orders-empty" style="display: none">
            <div class="empty-state-icon">-</div>
            No orders yet
          </div>
        </div>

        <!-- Panel 7: Backtest Comparison -->
        <div class="panel panel-full">
          <div class="panel-title">Backtest Results</div>
          <div class="table-scroll">
            <table class="data-table" id="backtest-table">
              <thead>
                <tr>
                  <th>Strategy</th>
                  <th class="right">Return</th>
                  <th class="right">Sharpe</th>
                  <th class="right">Sortino</th>
                  <th class="right">Max DD</th>
                  <th class="right">Win Rate</th>
                  <th class="right">Profit Factor</th>
                  <th class="right">Trades</th>
                  <th class="right">Final Equity</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="empty-state" id="backtest-empty" style="display: none">
            <div class="empty-state-icon">-</div>
            No backtest results available
          </div>
        </div>
      </div>

      <footer class="dashboard-footer">
        OpenFinClaw Trading Dashboard &middot; Real-time via SSE
      </footer>
    </div>

    <script>
      (function () {
        "use strict";
        var DATA = /*__TRADING_DATA__*/ {};

        // ── Helpers ──
        function fmt(n) {
          return (n || 0).toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        }
        function fmtPct(n) {
          return (n || 0).toFixed(2);
        }
        function signed(n) {
          return (n >= 0 ? "+" : "") + fmt(n);
        }
        function signedPct(n) {
          return (n >= 0 ? "+" : "") + fmtPct(n) + "%";
        }
        function pnlClass(n) {
          return n > 0 ? "pnl-positive" : n < 0 ? "pnl-negative" : "pnl-neutral";
        }
        function setText(id, text) {
          var el = document.getElementById(id);
          if (el) el.textContent = text;
        }
        function formatTime(ts) {
          if (!ts) return "--";
          var d = new Date(ts);
          return (
            d.toLocaleDateString("en-US", { month: "short", day: "numeric" }) +
            " " +
            d.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", hour12: false })
          );
        }

        // ── Chart instances (persisted across updates) ──
        var equityChart = null;
        var allocChart = null;
        var ALLOC_COLORS = [
          "#ff5a2d",
          "#448aff",
          "#00c853",
          "#ffb020",
          "#e040fb",
          "#8b7f77",
          "#ff7a50",
        ];

        // ── Rebuild a table body from row data ──
        function rebuildTbody(tableId, emptyId, rows, buildRow) {
          var table = document.getElementById(tableId);
          var empty = document.getElementById(emptyId);
          if (rows.length === 0) {
            if (table) table.style.display = "none";
            if (empty) empty.style.display = "block";
          } else {
            if (table) table.style.display = "";
            if (empty) empty.style.display = "none";
            var tbody = table ? table.querySelector("tbody") : null;
            if (tbody) {
              tbody.innerHTML = "";
              for (var i = 0; i < rows.length; i++) {
                tbody.appendChild(buildRow(rows[i]));
              }
            }
          }
        }

        // ── Main update function (called on every SSE message or poll) ──
        function updateDashboard(DATA) {
          var summary = DATA.summary || {};
          var positions = DATA.positions || [];
          var orders = DATA.orders || [];
          var snapshots = DATA.snapshots || [];
          var strategies = DATA.strategies || [];
          var backtests = DATA.backtests || [];
          var allocations = DATA.allocations || {};

          // ── Timestamp ──
          setText(
            "timestamp",
            new Date().toLocaleString("en-US", { dateStyle: "medium", timeStyle: "short" }),
          );

          // ── Panel 1: Hero ──
          setText("hero-equity", "$" + fmt(summary.totalEquity));
          var pnlEl = document.getElementById("hero-pnl");
          if (pnlEl) {
            var dailyPnl = summary.dailyPnl || 0;
            var dailyPnlPct = summary.dailyPnlPct || 0;
            pnlEl.textContent = signed(dailyPnl) + " (" + signedPct(dailyPnlPct) + ")";
            pnlEl.className = "pnl " + pnlClass(dailyPnl);
          }
          setText("hero-positions", String(positions.length));
          setText("hero-strategies", String(strategies.length));
          setText("hero-win-rate", summary.winRate != null ? fmtPct(summary.winRate) + "%" : "--");
          setText("hero-sharpe", summary.avgSharpe != null ? summary.avgSharpe.toFixed(2) : "--");

          // ── Panel 2: Equity Curve (update existing chart or create new) ──
          var equityCanvas = document.getElementById("equity-chart");
          if (equityCanvas && snapshots.length > 1 && typeof Chart !== "undefined") {
            try {
              var labels = snapshots.map(function (s) {
                return formatTime(s.timestamp);
              });
              var equityValues = snapshots.map(function (s) {
                return s.equity;
              });

              if (equityChart) {
                equityChart.data.labels = labels;
                equityChart.data.datasets[0].data = equityValues;
                equityChart.data.datasets[0].pointRadius = snapshots.length > 30 ? 0 : 3;
                equityChart.update("none");
              } else {
                var gradient = equityCanvas.getContext("2d").createLinearGradient(0, 0, 0, 280);
                gradient.addColorStop(0, "rgba(0, 200, 83, 0.15)");
                gradient.addColorStop(1, "rgba(0, 200, 83, 0.0)");

                equityChart = new Chart(equityCanvas, {
                  type: "line",
                  data: {
                    labels: labels,
                    datasets: [
                      {
                        label: "Equity",
                        data: equityValues,
                        borderColor: "#00c853",
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: snapshots.length > 30 ? 0 : 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: "#00c853",
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: "index", intersect: false },
                    plugins: {
                      legend: { display: false },
                      tooltip: {
                        backgroundColor: "#181e27",
                        titleColor: "#e8edf4",
                        bodyColor: "#e8edf4",
                        borderColor: "#2a3546",
                        borderWidth: 1,
                        padding: 12,
                        titleFont: { family: "SF Mono, monospace", size: 11 },
                        bodyFont: { family: "SF Mono, monospace", size: 12 },
                        callbacks: {
                          label: function (ctx) {
                            return "$" + fmt(ctx.raw);
                          },
                        },
                      },
                    },
                    scales: {
                      x: {
                        grid: { color: "rgba(30,39,54,0.5)", drawBorder: false },
                        ticks: {
                          color: "#4a5568",
                          font: { size: 10, family: "SF Mono, monospace" },
                          maxRotation: 0,
                          maxTicksLimit: 8,
                        },
                      },
                      y: {
                        grid: { color: "rgba(30,39,54,0.5)", drawBorder: false },
                        ticks: {
                          color: "#4a5568",
                          font: { size: 10, family: "SF Mono, monospace" },
                          callback: function (v) {
                            return "$" + v.toLocaleString();
                          },
                        },
                      },
                    },
                  },
                });
              }
            } catch (e) {
              console.warn("Equity chart error:", e);
            }
          }

          // ── Panel 3: Allocation Doughnut ──
          var allocCanvas = document.getElementById("alloc-chart");
          var allocItems = allocations.items || [];
          var allocLegendEl = document.getElementById("alloc-legend");

          if (allocCanvas && typeof Chart !== "undefined") {
            try {
              var allocLabels = allocItems.map(function (a) {
                return a.strategyId || a.symbol;
              });
              var allocValues = allocItems.map(function (a) {
                return a.capitalUsd || a.weight || 0;
              });
              var colors = ALLOC_COLORS.slice();
              if (allocations.cashReserve > 0) {
                allocLabels.push("Cash");
                allocValues.push(allocations.cashReserve);
                colors.push("#1e2736");
              }

              if (allocChart && allocItems.length > 0) {
                allocChart.data.labels = allocLabels;
                allocChart.data.datasets[0].data = allocValues;
                allocChart.data.datasets[0].backgroundColor = colors.slice(0, allocLabels.length);
                allocChart.update("none");
              } else if (allocItems.length > 0) {
                allocChart = new Chart(allocCanvas, {
                  type: "doughnut",
                  data: {
                    labels: allocLabels,
                    datasets: [
                      {
                        data: allocValues,
                        backgroundColor: colors.slice(0, allocLabels.length),
                        borderColor: "#12171e",
                        borderWidth: 3,
                        hoverBorderWidth: 0,
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: "70%",
                    plugins: {
                      legend: { display: false },
                      tooltip: {
                        backgroundColor: "#181e27",
                        titleColor: "#e8edf4",
                        bodyColor: "#e8edf4",
                        borderColor: "#2a3546",
                        borderWidth: 1,
                        callbacks: {
                          label: function (ctx) {
                            return ctx.label + ": $" + fmt(ctx.raw);
                          },
                        },
                      },
                    },
                  },
                });
              }

              // Rebuild legend
              if (allocLegendEl) {
                allocLegendEl.innerHTML = "";
                for (var li = 0; li < allocLabels.length; li++) {
                  var item = document.createElement("div");
                  item.className = "alloc-legend-item";
                  var dot = document.createElement("div");
                  dot.className = "alloc-legend-dot";
                  dot.style.backgroundColor = colors[li] || "#8b7f77";
                  var lbl = document.createElement("span");
                  lbl.textContent = allocLabels[li];
                  item.appendChild(dot);
                  item.appendChild(lbl);
                  allocLegendEl.appendChild(item);
                }
              }
            } catch (e) {
              console.warn("Allocation chart error:", e);
            }
          }

          // ── Panel 4: Positions ──
          rebuildTbody("positions-table", "positions-empty", positions, function (pos) {
            var tr = document.createElement("tr");

            var tdSymbol = document.createElement("td");
            tdSymbol.textContent = pos.symbol;
            tdSymbol.style.fontWeight = "600";

            var tdSide = document.createElement("td");
            tdSide.textContent = pos.side.toUpperCase();
            tdSide.className = pos.side === "long" ? "side-long" : "side-short";

            var tdQty = document.createElement("td");
            tdQty.className = "right";
            tdQty.textContent = pos.quantity.toString();

            var tdEntry = document.createElement("td");
            tdEntry.className = "right";
            tdEntry.textContent = "$" + fmt(pos.entryPrice);

            var tdCurrent = document.createElement("td");
            tdCurrent.className = "right";
            tdCurrent.textContent = "$" + fmt(pos.currentPrice);

            var pnlVal = pos.unrealizedPnl || 0;
            var pnlPctVal =
              pos.entryPrice > 0 ? ((pos.currentPrice - pos.entryPrice) / pos.entryPrice) * 100 : 0;
            if (pos.side === "short") pnlPctVal = -pnlPctVal;

            var tdPnl = document.createElement("td");
            tdPnl.className = "right pnl-cell " + pnlClass(pnlVal);
            tdPnl.textContent = signed(pnlVal);

            var tdPnlPct = document.createElement("td");
            tdPnlPct.className = "right pnl-cell " + pnlClass(pnlPctVal);
            tdPnlPct.textContent = signedPct(pnlPctVal);

            tr.append(tdSymbol, tdSide, tdQty, tdEntry, tdCurrent, tdPnl, tdPnlPct);
            return tr;
          });

          // ── Panel 5: Strategy Cards ──
          var stratGrid = document.getElementById("strategy-grid");
          var stratEmpty = document.getElementById("strategies-empty");
          if (strategies.length === 0) {
            if (stratGrid) {
              stratGrid.style.display = "none";
              stratGrid.innerHTML = "";
            }
            if (stratEmpty) stratEmpty.style.display = "block";
          } else if (stratGrid) {
            stratGrid.style.display = "";
            if (stratEmpty) stratEmpty.style.display = "none";
            stratGrid.innerHTML = "";
            for (var si = 0; si < strategies.length; si++) {
              var strat = strategies[si];
              var card = document.createElement("div");
              card.className = "strategy-card";

              var header = document.createElement("div");
              header.className = "strategy-card-header";
              var nameSpan = document.createElement("span");
              nameSpan.className = "strategy-card-name";
              nameSpan.textContent = strat.name || strat.id;
              var lvlBadge = document.createElement("span");
              var lvlShort = (strat.level || "L0").replace("_", " ").split(" ")[0];
              var lvlKey = (strat.level || "L0_INCUBATE").split("_")[0];
              lvlBadge.className = "level-badge level-" + lvlKey;
              lvlBadge.textContent = lvlShort;
              header.appendChild(nameSpan);
              header.appendChild(lvlBadge);

              var stats = document.createElement("div");
              stats.className = "strategy-card-stats";

              var statItems = [
                {
                  label: "Return",
                  value: strat.totalReturn != null ? signedPct(strat.totalReturn) : "--",
                  cls: pnlClass(strat.totalReturn || 0),
                },
                {
                  label: "Sharpe",
                  value: strat.sharpe != null ? strat.sharpe.toFixed(2) : "--",
                  cls:
                    strat.sharpe >= 1
                      ? "sharpe-good"
                      : strat.sharpe >= 0
                        ? "sharpe-ok"
                        : "sharpe-bad",
                },
                {
                  label: "Max DD",
                  value: strat.maxDrawdown != null ? fmtPct(strat.maxDrawdown) + "%" : "--",
                  cls: "",
                },
                {
                  label: "Trades",
                  value: strat.totalTrades != null ? String(strat.totalTrades) : "--",
                  cls: "",
                },
              ];

              for (var sti = 0; sti < statItems.length; sti++) {
                var statDiv = document.createElement("div");
                statDiv.className = "strategy-stat";
                var statLabel = document.createElement("span");
                statLabel.className = "stat-label";
                statLabel.textContent = statItems[sti].label;
                var statValue = document.createElement("span");
                statValue.className =
                  "stat-value" + (statItems[sti].cls ? " " + statItems[sti].cls : "");
                statValue.textContent = statItems[sti].value;
                statDiv.appendChild(statLabel);
                statDiv.appendChild(statValue);
                stats.appendChild(statDiv);
              }

              card.appendChild(header);
              card.appendChild(stats);
              stratGrid.appendChild(card);
            }
          }

          // ── Panel 6: Orders ──
          rebuildTbody("orders-table", "orders-empty", orders, function (o) {
            var otr = document.createElement("tr");

            var otdTime = document.createElement("td");
            otdTime.textContent = formatTime(o.filledAt || o.createdAt);

            var otdSymbol = document.createElement("td");
            otdSymbol.textContent = o.symbol;
            otdSymbol.style.fontWeight = "600";

            var otdSide = document.createElement("td");
            otdSide.textContent = o.side.toUpperCase();
            otdSide.className = o.side === "buy" ? "side-long" : "side-short";

            var otdQty = document.createElement("td");
            otdQty.className = "right";
            otdQty.textContent = o.quantity.toString();

            var otdPrice = document.createElement("td");
            otdPrice.className = "right";
            otdPrice.textContent = o.fillPrice ? "$" + fmt(o.fillPrice) : "--";

            var otdStatus = document.createElement("td");
            var statusSpan = document.createElement("span");
            statusSpan.className = "status-badge status-" + (o.status || "pending");
            statusSpan.textContent = (o.status || "pending").toUpperCase();
            otdStatus.appendChild(statusSpan);

            var otdComm = document.createElement("td");
            otdComm.className = "right";
            otdComm.textContent = o.commission ? "$" + o.commission.toFixed(4) : "--";

            var otdStrat = document.createElement("td");
            otdStrat.textContent = o.strategyId || "--";
            otdStrat.style.color = "var(--fc-text-secondary)";

            otr.append(otdTime, otdSymbol, otdSide, otdQty, otdPrice, otdStatus, otdComm, otdStrat);
            return otr;
          });

          // ── Panel 7: Backtest Results ──
          rebuildTbody("backtest-table", "backtest-empty", backtests, function (bt) {
            var btr = document.createElement("tr");

            var btdName = document.createElement("td");
            btdName.textContent = bt.strategyId || bt.name || "Unknown";
            btdName.style.fontWeight = "600";

            var btdReturn = document.createElement("td");
            btdReturn.className = "right " + pnlClass(bt.totalReturn);
            btdReturn.textContent = signedPct(bt.totalReturn);

            var btdSharpe = document.createElement("td");
            btdSharpe.className =
              "right " +
              (bt.sharpe >= 1 ? "sharpe-good" : bt.sharpe >= 0 ? "sharpe-ok" : "sharpe-bad");
            btdSharpe.textContent = bt.sharpe.toFixed(3);

            var btdSortino = document.createElement("td");
            btdSortino.className = "right";
            btdSortino.textContent = bt.sortino != null ? bt.sortino.toFixed(3) : "--";

            var btdDD = document.createElement("td");
            btdDD.className = "right pnl-negative";
            btdDD.textContent = fmtPct(bt.maxDrawdown) + "%";

            var btdWin = document.createElement("td");
            btdWin.className = "right";
            btdWin.textContent = fmtPct(bt.winRate) + "%";

            var btdPF = document.createElement("td");
            btdPF.className = "right";
            btdPF.textContent = bt.profitFactor != null ? bt.profitFactor.toFixed(2) : "--";

            var btdTrades = document.createElement("td");
            btdTrades.className = "right";
            btdTrades.textContent = String(bt.totalTrades);

            var btdFinal = document.createElement("td");
            btdFinal.className = "right " + pnlClass(bt.finalEquity - bt.initialCapital);
            btdFinal.textContent = "$" + fmt(bt.finalEquity);

            btr.append(
              btdName,
              btdReturn,
              btdSharpe,
              btdSortino,
              btdDD,
              btdWin,
              btdPF,
              btdTrades,
              btdFinal,
            );
            return btr;
          });
        }

        // ── Initial render from server-injected data ──
        updateDashboard(DATA);

        // ── Real-time updates via SSE, with fetch polling fallback ──
        function startSSE() {
          if (typeof EventSource === "undefined") {
            startPolling();
            return;
          }
          var es = new EventSource("/api/v1/finance/trading/stream");
          es.onmessage = function (event) {
            try {
              var data = JSON.parse(event.data);
              updateDashboard(data);
            } catch (e) {
              console.warn("SSE parse error:", e);
            }
          };
          es.onerror = function () {
            // SSE failed — close and fall back to polling
            es.close();
            console.warn("SSE connection lost, falling back to polling");
            startPolling();
          };
        }

        function startPolling() {
          setInterval(function () {
            fetch("/api/v1/finance/trading")
              .then(function (r) {
                return r.ok ? r.json() : null;
              })
              .then(function (d) {
                if (d) updateDashboard(d);
              })
              .catch(function () {});
          }, 10000);
        }

        startSSE();
      })();
    </script>
  </body>
</html>

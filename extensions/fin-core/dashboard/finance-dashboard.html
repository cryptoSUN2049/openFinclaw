<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OpenFinclaw Finance Dashboard</title>
    <style>
      /*__FINANCE_CSS__*/
    </style>
  </head>
  <body>
    <main class="layout">
      <header class="hero">
        <p class="eyebrow">OpenFinclaw Control</p>
        <h1>Finance Dashboard</h1>
        <p class="sub">Exchange wiring, trading limits, and finance plugin status at a glance.</p>
      </header>

      <section class="panel" id="summary"></section>
      <section class="panel" id="trading"></section>
      <section class="panel" id="exchanges"></section>
      <section class="panel" id="plugins"></section>
    </main>

    <script>
      (function () {
        var financeData = /*__FINANCE_DATA__*/ {};

        function esc(str) {
          var d = document.createElement("div");
          d.textContent = String(str);
          return d.innerHTML;
        }

        function money(value) {
          return "$" + Number(value || 0).toLocaleString();
        }

        function renderSummary() {
          var root = document.getElementById("summary");
          root.innerHTML =
            "<h2>Summary</h2>" +
            '<div class="metrics">' +
            "<article><span>Exchanges</span><strong>" +
            financeData.exchanges.length +
            "</strong></article>" +
            "<article><span>Plugins Enabled</span><strong>" +
            financeData.plugins.enabled +
            "/" +
            financeData.plugins.total +
            "</strong></article>" +
            "<article><span>Trading</span><strong>" +
            (financeData.trading.enabled ? "Enabled" : "Disabled") +
            "</strong></article>" +
            "<article><span>Updated</span><strong>" +
            new Date(financeData.generatedAt).toLocaleString() +
            "</strong></article>" +
            "</div>";
        }

        function renderTrading() {
          var root = document.getElementById("trading");
          var trading = financeData.trading;
          root.innerHTML =
            "<h2>Trading Risk Limits</h2>" +
            '<ul class="kv">' +
            "<li><span>Auto trade limit</span><strong>" +
            money(trading.maxAutoTradeUsd) +
            "</strong></li>" +
            "<li><span>Confirm threshold</span><strong>" +
            money(trading.confirmThresholdUsd) +
            "</strong></li>" +
            "<li><span>Daily loss limit</span><strong>" +
            money(trading.maxDailyLossUsd) +
            "</strong></li>" +
            "<li><span>Max position</span><strong>" +
            trading.maxPositionPct +
            "%</strong></li>" +
            "<li><span>Max leverage</span><strong>" +
            trading.maxLeverage +
            "x</strong></li>" +
            "</ul>";
        }

        function renderExchanges() {
          var root = document.getElementById("exchanges");
          if (financeData.exchanges.length === 0) {
            root.innerHTML = "<h2>Exchanges</h2><p class='empty'>No exchanges configured.</p>";
            return;
          }

          var rows = "";
          for (var i = 0; i < financeData.exchanges.length; i++) {
            var entry = financeData.exchanges[i];
            rows +=
              "<tr><td>" +
              esc(entry.id) +
              "</td><td>" +
              esc(entry.exchange) +
              "</td><td>" +
              (entry.testnet ? "yes" : "no") +
              "</td></tr>";
          }

          root.innerHTML =
            "<h2>Exchanges</h2>" +
            "<table><thead><tr><th>Name</th><th>Type</th><th>Testnet</th></tr></thead>" +
            "<tbody>" +
            rows +
            "</tbody></table>";
        }

        function renderPlugins() {
          var root = document.getElementById("plugins");
          var rows = "";
          for (var i = 0; i < financeData.plugins.entries.length; i++) {
            var entry = financeData.plugins.entries[i];
            rows +=
              '<li class="' +
              (entry.enabled ? "ok" : "off") +
              '"><span>' +
              esc(entry.id) +
              "</span><strong>" +
              (entry.enabled ? "enabled" : "disabled") +
              "</strong></li>";
          }

          root.innerHTML =
            "<h2>Finance Plugin Matrix</h2>" + '<ul class="plugin-list">' + rows + "</ul>";
        }

        function updateDashboard(data) {
          financeData = data;
          renderSummary();
          renderTrading();
          renderExchanges();
          renderPlugins();
        }

        // Initial render
        updateDashboard(financeData);

        // SSE
        function startSSE() {
          var es = new EventSource("/api/v1/finance/config/stream");
          es.onmessage = function (ev) {
            try {
              updateDashboard(JSON.parse(ev.data));
            } catch (e) {
              console.warn("SSE parse error:", e);
            }
          };
          es.onerror = function () {
            es.close();
            startPolling();
          };
        }

        function startPolling() {
          setInterval(function () {
            fetch("/api/v1/finance/config")
              .then(function (r) {
                return r.json();
              })
              .then(function (data) {
                updateDashboard(data);
              })
              .catch(function () {});
          }, 30000);
        }

        if (typeof EventSource !== "undefined") {
          startSSE();
        } else {
          startPolling();
        }
      })();
    </script>
  </body>
</html>

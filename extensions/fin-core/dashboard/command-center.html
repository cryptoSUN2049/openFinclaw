<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenFinClaw — Command Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /*__CC_CSS__*/
    </style>
  </head>
  <body>
    <!-- RISK HALO -->
    <div class="risk-halo" id="riskHalo"></div>

    <!-- TOP BAR -->
    <header class="topbar">
      <span class="topbar__logo">OPENFINCLAW</span>
      <div class="topbar__sep"></div>
      <div class="topbar__eq">
        <span class="topbar__eq-val num" id="tbEquity">$0</span>
        <span class="topbar__eq-chg num" id="tbChange"></span>
      </div>
      <div class="topbar__fill"></div>
      <div class="topbar__agents">
        <div class="adot adot--mon"><span class="adot__pip"></span>Monitor</div>
        <div class="adot adot--str"><span class="adot__pip"></span>Strategy</div>
        <div class="adot adot--rsk"><span class="adot__pip"></span>Risk</div>
      </div>
      <div class="topbar__sep"></div>
      <span class="topbar__risk" id="riskBadge">NORMAL</span>
      <span class="topbar__clock num" id="clock">--:--</span>
      <button class="btn-estop" id="estopBtn">STOP</button>
    </header>

    <!-- 3-COLUMN LAYOUT -->
    <div class="layout">
      <!-- LEFT COLUMN -->
      <aside class="col-l">
        <div class="eq-mini fade-up d1">
          <div class="eq-mini__val num" id="eqVal">$0</div>
          <div class="eq-mini__chg num" id="eqChg"></div>
        </div>

        <div class="col-l__section fade-up d2">
          <div class="stat-pills">
            <div class="stat-pill">
              <div class="stat-pill__v num" id="spPositions">0</div>
              <div class="stat-pill__l">Positions</div>
              <div class="stat-pill__sub num" id="spPosPnl"></div>
            </div>
            <div class="stat-pill">
              <div class="stat-pill__v num" id="spStrategies">0</div>
              <div class="stat-pill__l">Strategies</div>
              <div class="stat-pill__sub dim num" id="spSharpe"></div>
            </div>
            <div class="stat-pill">
              <div class="stat-pill__v num" id="spAlerts">0</div>
              <div class="stat-pill__l">Alerts</div>
              <div class="stat-pill__sub dim" id="spTriggered"></div>
            </div>
            <div class="stat-pill" id="spPendingPill">
              <div class="stat-pill__v num" id="spPending">0</div>
              <div class="stat-pill__l">Pending</div>
              <div class="stat-pill__sub" id="spPendingHint"></div>
            </div>
          </div>
        </div>

        <div class="col-l__section fade-up d3">
          <div class="col-l__title">Open Positions</div>
          <div id="positionsList"></div>
        </div>

        <div class="col-l__section fade-up d4">
          <div class="col-l__title">Active Alerts</div>
          <div id="alertsList"></div>
        </div>

        <div class="col-l__section fade-up d5">
          <div class="qa-grid">
            <button class="qa-btn qa-btn--primary" onclick="openSlide('order')">Place Order</button>
            <button class="qa-btn" onclick="openSlide('alert')">Set Alert</button>
            <button class="qa-btn qa-btn--settings" onclick="openSlide('settings')">
              &#9881; Settings
            </button>
          </div>
        </div>
      </aside>

      <!-- CENTER COLUMN -->
      <main class="col-c">
        <!-- Pipeline -->
        <div class="panel-card fade-up d2">
          <div class="panel-card__head">
            <div class="panel-card__title">Strategy Pipeline</div>
          </div>
          <div class="pipeline" id="pipeline"></div>
        </div>

        <!-- Strategy Raceboard -->
        <div
          class="panel-card fade-up d3"
          style="flex: 1; display: flex; flex-direction: column; min-height: 0"
        >
          <div class="panel-card__head">
            <div class="panel-card__title">Strategy Raceboard</div>
            <span style="font-size: 9px; color: var(--text-dim)" id="stratCount"></span>
          </div>
          <div style="flex: 1; overflow-y: auto; margin: 0 -12px; padding: 0 12px">
            <table class="race-table">
              <thead>
                <tr>
                  <th style="width: 20px">#</th>
                  <th>Fitness</th>
                  <th>Strategy</th>
                  <th>Level</th>
                  <th>Return</th>
                  <th>Sharpe</th>
                  <th>Trades</th>
                  <th>Status</th>
                  <th style="width: 80px">Actions</th>
                </tr>
              </thead>
              <tbody id="stratBody"></tbody>
            </table>
            <div class="empty" id="stratEmpty" style="display: none">No strategies registered</div>
          </div>
        </div>
      </main>

      <!-- RIGHT COLUMN -->
      <aside class="col-r">
        <div class="col-r__head">
          <div class="col-r__title">Agent Activity</div>
          <div class="filter-chips">
            <button class="fchip active" data-ef="all" onclick="filterFeed('all', this)">
              All
            </button>
            <button
              class="fchip"
              data-ef="trade_pending"
              onclick="filterFeed('trade_pending', this)"
            >
              Pending
            </button>
            <button
              class="fchip"
              data-ef="trade_executed"
              onclick="filterFeed('trade_executed', this)"
            >
              Trades
            </button>
            <button class="fchip" data-ef="system" onclick="filterFeed('system', this)">
              System
            </button>
          </div>
        </div>
        <div class="col-r__feed" id="eventFeed"></div>
      </aside>
    </div>

    <!-- BOTTOM BAR -->
    <footer class="botbar">
      <div class="botbar__avatar"></div>
      <div class="botbar__msg" id="aiMsg"><em>Connecting...</em></div>
      <div class="botbar__status">
        <span id="sseStatus">SSE</span>
        <span class="botbar__dot" id="sseDot"></span>
      </div>
    </footer>

    <!-- SLIDE-OVER: Order Form -->
    <div class="slideover-backdrop" id="slideBackdrop" onclick="closeSlide()">
      <div class="slideover" onclick="event.stopPropagation()">
        <div class="slideover__head">
          <span class="slideover__title" id="slideTitle">Place Order</span>
          <button class="slideover__close" onclick="closeSlide()">&times;</button>
        </div>
        <div class="slideover__body" id="slideBody"></div>
      </div>
    </div>

    <!-- MODAL: Emergency Stop -->
    <div class="modal-bg" id="estopModal">
      <div class="modal-box">
        <div class="modal-box__icon">&#9632;</div>
        <div class="modal-box__title">Emergency Stop</div>
        <div class="modal-box__desc">
          This will immediately disable all trading and pause all running strategies. This action
          cannot be undone automatically.
        </div>
        <div class="modal-box__actions">
          <button class="modal-btn modal-btn--cancel" onclick="closeModal('estopModal')">
            Cancel
          </button>
          <button class="modal-btn modal-btn--danger" id="estopConfirm">CONFIRM STOP</button>
        </div>
      </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
      // ── SettingsBridge: iframe ↔ host postMessage for config read/write ──
      var SettingsBridge = (function () {
        var _reqId = 0;
        var _pending = {};
        var TIMEOUT_MS = 5000;
        window.addEventListener("message", function (ev) {
          var d = ev.data;
          if (!d || typeof d !== "object") return;
          if (
            (d.type === "fin-config-patch-result" || d.type === "fin-config-get-result") &&
            d._reqId != null
          ) {
            var p = _pending[d._reqId];
            if (!p) return;
            clearTimeout(p.timer);
            delete _pending[d._reqId];
            if (d.ok) p.resolve(d.type === "fin-config-get-result" ? d.values || {} : d);
            else p.reject(new Error(d.error || "Bridge error"));
          }
        });
        function _send(msg) {
          var id = ++_reqId;
          msg._reqId = id;
          return new Promise(function (resolve, reject) {
            var timer = setTimeout(function () {
              delete _pending[id];
              reject(new Error("SettingsBridge timeout"));
            }, TIMEOUT_MS);
            _pending[id] = { resolve: resolve, reject: reject, timer: timer };
            window.parent.postMessage(msg, "*");
          });
        }
        return {
          get: function (section) {
            return _send({ type: "fin-config-get", section: section });
          },
          patch: function (section, values) {
            return _send({ type: "fin-config-patch", section: section, values: values });
          },
        };
      })();
    </script>
    <script>
      (function () {
        "use strict";

        // ── Initial data injected by server ──
        var D = /*__CC_DATA__*/ {};

        // ── HTML escape ──
        function esc(s) {
          var el = document.createElement("span");
          el.textContent = s == null ? "" : String(s);
          return el.innerHTML;
        }

        // ── Number formatting ──
        function fmtUsd(n) {
          if (n == null) return "$0";
          var neg = n < 0;
          var abs = Math.abs(n);
          var s;
          if (abs >= 1e6) s = "$" + (abs / 1e6).toFixed(1) + "M";
          else if (abs >= 1e3) s = "$" + (abs / 1e3).toFixed(1) + "K";
          else s = "$" + abs.toFixed(2);
          return neg ? "-" + s : s;
        }
        function fmtPct(n) {
          return n == null ? "" : (n >= 0 ? "+" : "") + n.toFixed(2) + "%";
        }
        function pnlClass(n) {
          return n >= 0 ? "gain" : "loss";
        }

        // ── API Client ──
        function apiPost(url, body) {
          return fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body || {}),
          }).then(function (r) {
            return r.json().then(function (d) {
              return r.ok ? d : Promise.reject(d);
            });
          });
        }

        // ── Toast Notifications ──
        function toast(msg, type) {
          var el = document.createElement("div");
          el.className = "toast" + (type ? " toast--" + type : "");
          el.textContent = msg;
          document.getElementById("toastContainer").appendChild(el);
          requestAnimationFrame(function () {
            el.classList.add("show");
          });
          setTimeout(function () {
            el.classList.remove("show");
            setTimeout(function () {
              el.remove();
            }, 300);
          }, 3000);
        }

        // ── Clock ──
        function updateClock() {
          var now = new Date();
          var h = String(now.getHours()).padStart(2, "0");
          var m = String(now.getMinutes()).padStart(2, "0");
          document.getElementById("clock").textContent = h + ":" + m;
        }
        setInterval(updateClock, 10000);
        updateClock();

        // ── Time ago ──
        function timeAgo(ts) {
          var diff = Date.now() - ts;
          if (diff < 60000) return "just now";
          if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
          if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
          return Math.floor(diff / 86400000) + "d ago";
        }

        // ════════════════════════════════════════════════════
        // RENDERING — Trading Data
        // ════════════════════════════════════════════════════

        var tradingData = D.trading || {};
        var eventsData = D.events || {};

        function renderTrading(data) {
          tradingData = data;
          var s = data.summary || {};

          // Top bar equity
          document.getElementById("tbEquity").textContent = fmtUsd(s.totalEquity);
          var chgEl = document.getElementById("tbChange");
          if (s.dailyPnl != null) {
            chgEl.textContent =
              (s.dailyPnl >= 0 ? "+" : "") +
              fmtUsd(s.dailyPnl) +
              " (" +
              fmtPct(s.dailyPnlPct) +
              ")";
            chgEl.className = "topbar__eq-chg num " + pnlClass(s.dailyPnl);
          }

          // Left sidebar equity
          document.getElementById("eqVal").textContent = fmtUsd(s.totalEquity);
          var eqChg = document.getElementById("eqChg");
          if (s.dailyPnl != null) {
            eqChg.textContent =
              (s.dailyPnl >= 0 ? "+" : "") +
              fmtUsd(s.dailyPnl) +
              " today (" +
              fmtPct(s.dailyPnlPct) +
              ")";
            eqChg.className = "eq-mini__chg num " + pnlClass(s.dailyPnl);
          }

          // Stats pills
          document.getElementById("spPositions").textContent = s.positionCount || 0;
          var totalPosPnl = (data.positions || []).reduce(function (a, p) {
            return a + (p.unrealizedPnl || 0);
          }, 0);
          var ppEl = document.getElementById("spPosPnl");
          ppEl.textContent = (totalPosPnl >= 0 ? "+" : "") + fmtUsd(totalPosPnl);
          ppEl.className = "stat-pill__sub num " + pnlClass(totalPosPnl);

          document.getElementById("spStrategies").textContent = s.strategyCount || 0;
          document.getElementById("spSharpe").textContent =
            s.avgSharpe != null ? "Best " + s.avgSharpe.toFixed(2) : "";

          // Positions list
          var posEl = document.getElementById("positionsList");
          var positions = data.positions || [];
          if (positions.length === 0) {
            posEl.innerHTML = '<div class="empty">No open positions</div>';
          } else {
            var html = "";
            for (var i = 0; i < positions.length; i++) {
              var p = positions[i];
              var sideClass = p.side === "long" || p.side === "buy" ? "long" : "short";
              html +=
                '<div class="pos-row">' +
                '<span class="pos-row__sym num">' +
                esc(p.symbol) +
                "</span>" +
                '<span class="pos-row__side pos-row__side--' +
                sideClass +
                '">' +
                esc((p.side || "").toUpperCase()) +
                "</span>" +
                '<span class="pos-row__fill"></span>' +
                '<span class="pos-row__pnl ' +
                pnlClass(p.unrealizedPnl) +
                ' num">' +
                (p.unrealizedPnl >= 0 ? "+" : "") +
                fmtUsd(p.unrealizedPnl) +
                "</span>" +
                '<button class="pos-row__close" onclick="CC.closePosition(\'' +
                esc(p.symbol) +
                '\')" title="Close">&times;</button>' +
                "</div>";
            }
            posEl.innerHTML = html;
          }

          // Pipeline
          renderPipeline(data.strategies || []);

          // Strategy raceboard
          renderRaceboard(data.strategies || []);
        }

        function renderPipeline(strategies) {
          var counts = { L0: 0, L1: 0, L2: 0, L3: 0 };
          for (var i = 0; i < strategies.length; i++) {
            var lvl = strategies[i].level || "";
            if (lvl.indexOf("L0") === 0 || lvl === "L0_INCUBATE") counts.L0++;
            else if (lvl.indexOf("L1") === 0 || lvl === "L1_BACKTEST") counts.L1++;
            else if (lvl.indexOf("L2") === 0 || lvl === "L2_PAPER") counts.L2++;
            else if (lvl.indexOf("L3") === 0 || lvl === "L3_LIVE") counts.L3++;
          }
          var el = document.getElementById("pipeline");
          el.innerHTML =
            '<div class="pipe-stage pipe-stage--l0"><div class="pipe-stage__label" style="color:var(--l0)">L0</div><div class="pipe-stage__count">' +
            counts.L0 +
            "</div></div>" +
            '<div class="pipe-stage pipe-stage--l1"><div class="pipe-stage__label" style="color:var(--l1)">L1</div><div class="pipe-stage__count">' +
            counts.L1 +
            "</div></div>" +
            '<div class="pipe-stage pipe-stage--l2"><div class="pipe-stage__label" style="color:var(--l2)">L2</div><div class="pipe-stage__count">' +
            counts.L2 +
            "</div></div>" +
            '<div class="pipe-stage pipe-stage--l3"><div class="pipe-stage__label" style="color:var(--l3)">L3</div><div class="pipe-stage__count">' +
            counts.L3 +
            "</div></div>";
        }

        function levelClass(level) {
          if (!level) return "l0";
          if (level.indexOf("L3") === 0) return "l3";
          if (level.indexOf("L2") === 0) return "l2";
          if (level.indexOf("L1") === 0) return "l1";
          return "l0";
        }

        function levelLabel(level) {
          if (!level) return "L0";
          if (level.indexOf("L3") === 0) return "L3 LIVE";
          if (level.indexOf("L2") === 0) return "L2 PAPER";
          if (level.indexOf("L1") === 0) return "L1 BACK";
          return "L0";
        }

        function renderRaceboard(strategies) {
          var body = document.getElementById("stratBody");
          var empty = document.getElementById("stratEmpty");
          document.getElementById("stratCount").textContent = strategies.length + " strategies";

          if (strategies.length === 0) {
            body.innerHTML = "";
            empty.style.display = "";
            return;
          }
          empty.style.display = "none";

          // Sort by fitness (totalReturn as proxy)
          var sorted = strategies.slice().sort(function (a, b) {
            return (b.totalReturn || 0) - (a.totalReturn || 0);
          });

          var html = "";
          for (var i = 0; i < sorted.length; i++) {
            var s = sorted[i];
            var lc = levelClass(s.level);
            var status = s.status || "running";
            var statusDotCls =
              status === "paused" ? "paused" : status === "stopped" ? "stopped" : "running";
            var fitness = s.sharpe != null ? Math.min(s.sharpe / 2, 1) : 0;
            var fitnessColor =
              fitness > 0.6 ? "var(--gain)" : fitness > 0.3 ? "var(--warn)" : "var(--info)";
            var canPromote = lc !== "l3" && s.level !== "KILLED";
            var canPause = status === "running" && s.level !== "KILLED";
            var canResume = status === "paused";
            var canKill = s.level !== "KILLED";

            html +=
              "<tr>" +
              "<td>" +
              (i + 1) +
              "</td>" +
              '<td><span class="fitness-bar"><span class="fitness-bar__fill" style="width:' +
              (fitness * 100).toFixed(0) +
              "%;background:" +
              fitnessColor +
              '"></span></span>' +
              '<span class="num" style="color:' +
              fitnessColor +
              '">' +
              (s.sharpe != null ? s.sharpe.toFixed(2) : "-") +
              "</span></td>" +
              '<td><span class="strat-name">' +
              esc(s.name) +
              "</span></td>" +
              '<td><span class="level-badge level-badge--' +
              lc +
              '">' +
              esc(levelLabel(s.level)) +
              "</span></td>" +
              '<td class="' +
              pnlClass(s.totalReturn) +
              ' num">' +
              (s.totalReturn != null ? fmtPct(s.totalReturn * 100) : "-") +
              "</td>" +
              '<td class="num">' +
              (s.sharpe != null ? s.sharpe.toFixed(2) : "-") +
              "</td>" +
              '<td class="num">' +
              (s.totalTrades || 0) +
              "</td>" +
              '<td><span class="status-dot status-dot--' +
              statusDotCls +
              '"></span><span style="font-size:9px" class="' +
              (status === "running" ? "gain" : "dim") +
              '">' +
              esc(status) +
              "</span></td>" +
              '<td><div class="race-actions">' +
              (canPromote
                ? '<button class="race-act race-act--promote" title="Promote" onclick="CC.promoteStrategy(\'' +
                  esc(s.id) +
                  "')\">&#x2B06;</button>"
                : "") +
              (canPause
                ? '<button class="race-act race-act--pause" title="Pause" onclick="CC.pauseStrategy(\'' +
                  esc(s.id) +
                  "')\">&#x23F8;</button>"
                : "") +
              (canResume
                ? '<button class="race-act race-act--play" title="Resume" onclick="CC.resumeStrategy(\'' +
                  esc(s.id) +
                  "')\">&#x25B6;</button>"
                : "") +
              (canKill
                ? '<button class="race-act race-act--kill" title="Kill" onclick="CC.killStrategy(\'' +
                  esc(s.id) +
                  "')\">&#x2715;</button>"
                : "") +
              "</div></td>" +
              "</tr>";
          }
          body.innerHTML = html;
        }

        // ════════════════════════════════════════════════════
        // RENDERING — Events & Alerts
        // ════════════════════════════════════════════════════

        var currentFilter = "all";
        var allEvents = [];

        function renderEvents(data) {
          eventsData = data;
          allEvents = data.events || [];

          // Pending count
          var pending = data.pendingCount || 0;
          document.getElementById("spPending").textContent = pending;
          var pill = document.getElementById("spPendingPill");
          var hint = document.getElementById("spPendingHint");
          if (pending > 0) {
            pill.classList.add("stat-pill--pending");
            document.getElementById("spPending").style.color = "var(--warn)";
            hint.textContent = "Needs you";
            hint.style.color = "var(--warn)";
          } else {
            pill.classList.remove("stat-pill--pending");
            document.getElementById("spPending").style.color = "";
            hint.textContent = "All clear";
            hint.style.color = "";
          }

          renderFeed();
        }

        function renderFeed() {
          var feed = document.getElementById("eventFeed");
          var events = allEvents;

          if (currentFilter !== "all") {
            events = events.filter(function (e) {
              return e.type === currentFilter;
            });
          }

          if (events.length === 0) {
            feed.innerHTML = '<div class="empty">No events</div>';
            return;
          }

          var html = "";
          var limit = Math.min(events.length, 50);
          for (var i = 0; i < limit; i++) {
            var e = events[i];
            var typeClass = "system";
            var typeLabel = "SYSTEM";
            if (e.type === "trade_pending") {
              typeClass = "approval";
              typeLabel = "APPROVAL";
            } else if (e.type === "trade_executed") {
              typeClass = "executed";
              typeLabel = "EXECUTED";
            } else if (e.type === "strategy_promoted" || e.type === "strategy_killed") {
              typeClass = "evolution";
              typeLabel = "STRATEGY";
            } else if (e.type === "alert_triggered") {
              typeClass = "alert";
              typeLabel = "ALERT";
            } else if (e.type === "emergency_stop") {
              typeClass = "alert";
              typeLabel = "E-STOP";
            }

            html +=
              '<div class="fcard fcard--' +
              typeClass +
              '">' +
              '<div class="fcard__top">' +
              '<span class="fcard__type fcard__type--' +
              typeClass +
              '">' +
              typeLabel +
              "</span>" +
              '<span class="fcard__time">' +
              timeAgo(e.timestamp) +
              "</span>" +
              "</div>" +
              '<div class="fcard__title">' +
              esc(e.title) +
              "</div>" +
              '<div class="fcard__desc">' +
              esc(e.detail) +
              "</div>";

            if (e.status === "pending" && e.type === "trade_pending") {
              html +=
                '<div class="fcard__actions">' +
                '<button class="fcard__btn fcard__btn--approve" onclick="CC.approveEvent(\'' +
                esc(e.id) +
                "')\">Approve</button>" +
                '<button class="fcard__btn fcard__btn--reject" onclick="CC.rejectEvent(\'' +
                esc(e.id) +
                "')\">Reject</button>" +
                "</div>";
            }

            html += "</div>";
          }
          feed.innerHTML = html;
        }

        function renderAlerts(alerts) {
          var el = document.getElementById("alertsList");
          var active = (alerts || []).filter(function (a) {
            return !a.triggeredAt;
          });
          var triggered = (alerts || []).filter(function (a) {
            return !!a.triggeredAt;
          });

          document.getElementById("spAlerts").textContent = active.length;
          document.getElementById("spTriggered").textContent = triggered.length + " triggered";

          if (active.length === 0) {
            el.innerHTML = '<div class="empty">No active alerts</div>';
            return;
          }

          var html = "";
          for (var i = 0; i < active.length; i++) {
            var a = active[i];
            var label = "";
            if (a.condition) {
              if (a.condition.kind === "price_above")
                label = (a.condition.symbol || "") + " > $" + (a.condition.price || "");
              else if (a.condition.kind === "price_below")
                label = (a.condition.symbol || "") + " < $" + (a.condition.price || "");
              else if (a.condition.kind === "pnl_threshold")
                label =
                  "PnL " + (a.condition.direction || "") + " > $" + (a.condition.threshold || "");
              else label = a.condition.kind;
            }
            html +=
              '<div class="alert-row">' +
              '<span class="alert-pip"></span>' +
              '<span class="num">' +
              esc(label) +
              "</span>" +
              '<button class="alert-row__rm" onclick="CC.removeAlert(\'' +
              esc(a.id) +
              '\')" title="Remove">&times;</button>' +
              "</div>";
          }
          el.innerHTML = html;
        }

        // ════════════════════════════════════════════════════
        // SSE MANAGER — Dual-stream + reconnect
        // ════════════════════════════════════════════════════

        var sseTrading = null;
        var sseEvents = null;
        var sseRetry = { trading: 0, events: 0 };
        var maxRetry = 30000;

        function connectTradingSSE() {
          if (sseTrading) {
            try {
              sseTrading.close();
            } catch (e) {}
          }
          sseTrading = new EventSource("/api/v1/finance/trading/stream");
          sseTrading.onmessage = function (ev) {
            sseRetry.trading = 0;
            updateSSEStatus(true);
            try {
              renderTrading(JSON.parse(ev.data));
            } catch (e) {}
          };
          sseTrading.onerror = function () {
            sseTrading.close();
            sseRetry.trading = Math.min(sseRetry.trading * 2 || 1000, maxRetry);
            updateSSEStatus(false);
            setTimeout(connectTradingSSE, sseRetry.trading);
          };
        }

        function connectEventsSSE() {
          if (sseEvents) {
            try {
              sseEvents.close();
            } catch (e) {}
          }
          sseEvents = new EventSource("/api/v1/finance/events/stream");
          sseEvents.onmessage = function (ev) {
            sseRetry.events = 0;
            updateSSEStatus(true);
            try {
              var msg = JSON.parse(ev.data);
              if (msg.type === "new_event") {
                // Prepend new event
                allEvents.unshift(msg.event);
                eventsData.pendingCount = msg.pendingCount;
                renderEvents(eventsData);
              } else {
                renderEvents(msg);
              }
            } catch (e) {}
          };
          sseEvents.onerror = function () {
            sseEvents.close();
            sseRetry.events = Math.min(sseRetry.events * 2 || 1000, maxRetry);
            updateSSEStatus(false);
            setTimeout(connectEventsSSE, sseRetry.events);
          };
        }

        function updateSSEStatus(connected) {
          var dot = document.getElementById("sseDot");
          var label = document.getElementById("sseStatus");
          if (connected) {
            dot.className = "botbar__dot";
            label.textContent = "SSE Connected";
          } else {
            dot.className = "botbar__dot off";
            label.textContent = "SSE Reconnecting...";
          }
        }

        // Load alerts separately (no SSE for alerts, poll)
        function fetchAlerts() {
          fetch("/api/v1/finance/alerts")
            .then(function (r) {
              return r.json();
            })
            .then(function (d) {
              renderAlerts(d.alerts || []);
            })
            .catch(function () {});
        }

        // ════════════════════════════════════════════════════
        // ACTION HANDLERS
        // ════════════════════════════════════════════════════

        window.CC = {
          closePosition: function (symbol) {
            apiPost("/api/v1/finance/positions/close", { symbol: symbol })
              .then(function () {
                toast("Position closed: " + symbol, "success");
              })
              .catch(function (e) {
                toast(e.error || "Failed to close position", "error");
              });
          },

          approveEvent: function (id) {
            apiPost("/api/v1/finance/events/approve", { id: id, action: "approve" })
              .then(function () {
                toast("Trade approved", "success");
              })
              .catch(function (e) {
                toast(e.error || "Approval failed", "error");
              });
          },

          rejectEvent: function (id) {
            apiPost("/api/v1/finance/events/approve", {
              id: id,
              action: "reject",
              reason: "Rejected via Command Center",
            })
              .then(function () {
                toast("Trade rejected", "warn");
              })
              .catch(function (e) {
                toast(e.error || "Rejection failed", "error");
              });
          },

          pauseStrategy: function (id) {
            apiPost("/api/v1/finance/strategies/pause", { id: id })
              .then(function () {
                toast("Strategy paused", "success");
              })
              .catch(function (e) {
                toast(e.error || "Failed to pause", "error");
              });
          },

          resumeStrategy: function (id) {
            apiPost("/api/v1/finance/strategies/resume", { id: id })
              .then(function () {
                toast("Strategy resumed", "success");
              })
              .catch(function (e) {
                toast(e.error || "Failed to resume", "error");
              });
          },

          killStrategy: function (id) {
            if (!confirm("Kill this strategy permanently?")) return;
            apiPost("/api/v1/finance/strategies/kill", { id: id })
              .then(function () {
                toast("Strategy killed", "warn");
              })
              .catch(function (e) {
                toast(e.error || "Failed to kill", "error");
              });
          },

          promoteStrategy: function (id) {
            apiPost("/api/v1/finance/strategies/promote", { id: id })
              .then(function (d) {
                toast("Promoted: " + (d.from || "") + " -> " + (d.to || ""), "success");
              })
              .catch(function (e) {
                toast(e.error || "Failed to promote", "error");
              });
          },

          removeAlert: function (id) {
            apiPost("/api/v1/finance/alerts/remove", { id: id })
              .then(function () {
                toast("Alert removed", "success");
                fetchAlerts();
              })
              .catch(function (e) {
                toast(e.error || "Failed to remove alert", "error");
              });
          },

          submitOrder: function () {
            var form = document.getElementById("orderForm");
            if (!form) return;
            var symbol = form.querySelector("[name=symbol]").value.trim();
            var qty = parseFloat(form.querySelector("[name=quantity]").value);
            var side = document.querySelector(".bs-toggle__btn.active-buy") ? "buy" : "sell";
            var type = form.querySelector("[name=orderType]").value;
            var price = parseFloat(form.querySelector("[name=price]").value) || 0;

            if (!symbol || !qty) {
              toast("Symbol and quantity are required", "error");
              return;
            }

            apiPost("/api/v1/finance/orders", {
              symbol: symbol,
              side: side,
              type: type,
              quantity: qty,
              currentPrice: price,
              limitPrice: type === "limit" ? price : undefined,
            })
              .then(function (d) {
                if (d.status === "pending_approval") {
                  toast("Order requires approval (event: " + d.eventId + ")", "warn");
                } else {
                  toast("Order placed: " + symbol, "success");
                }
                closeSlide();
              })
              .catch(function (e) {
                toast(e.error || "Order failed", "error");
              });
          },

          loadSettings: function () {
            Promise.all([SettingsBridge.get("trading"), SettingsBridge.get("paperTrading")])
              .then(function (results) {
                var trading = results[0] || {};
                var paper = results[1] || {};
                var el = function (id) {
                  return document.getElementById(id);
                };
                if (el("s_enabled")) el("s_enabled").checked = trading.enabled !== false;
                if (el("s_maxAutoTradeUsd"))
                  el("s_maxAutoTradeUsd").value = trading.maxAutoTradeUsd || "";
                if (el("s_confirmationThresholdUsd"))
                  el("s_confirmationThresholdUsd").value = trading.confirmationThresholdUsd || "";
                if (el("s_dailyLossLimitUsd"))
                  el("s_dailyLossLimitUsd").value = trading.dailyLossLimitUsd || "";
                if (el("s_maxPositionPct"))
                  el("s_maxPositionPct").value = trading.maxPositionPct || "";
                if (el("s_maxLeverage")) el("s_maxLeverage").value = trading.maxLeverage || "";
                if (el("s_allowPairs"))
                  el("s_allowPairs").value = (trading.allowPairs || []).join(", ");
                if (el("s_blockPairs"))
                  el("s_blockPairs").value = (trading.blockPairs || []).join(", ");
                if (el("s_defaultCapital"))
                  el("s_defaultCapital").value = paper.defaultCapital || "";
                if (el("s_slippageModel"))
                  el("s_slippageModel").value = paper.slippageModel || "constant";
                if (el("s_constantSlippageBps"))
                  el("s_constantSlippageBps").value = paper.constantSlippageBps || "";
                if (el("s_signalCheckIntervalSec"))
                  el("s_signalCheckIntervalSec").value = paper.signalCheckIntervalSec || "";
                var us = paper.us || {};
                var hk = paper.hk || {};
                var cn = paper.cn || {};
                if (el("s_usAdapter")) el("s_usAdapter").value = us.adapter || "alpaca";
                if (el("s_hkAdapter")) el("s_hkAdapter").value = hk.adapter || "futu";
                if (el("s_cnAdapter")) el("s_cnAdapter").value = cn.adapter || "openctp";
              })
              .catch(function (e) {
                toast("Failed to load settings: " + e.message, "error");
              });
          },

          saveSettings: function () {
            var el = function (id) {
              return document.getElementById(id);
            };
            var parsePairs = function (s) {
              return (s || "")
                .split(",")
                .map(function (p) {
                  return p.trim();
                })
                .filter(Boolean);
            };
            var tradingPatch = {
              enabled: el("s_enabled") ? el("s_enabled").checked : true,
              maxAutoTradeUsd: parseFloat(el("s_maxAutoTradeUsd").value) || undefined,
              confirmationThresholdUsd:
                parseFloat(el("s_confirmationThresholdUsd").value) || undefined,
              dailyLossLimitUsd: parseFloat(el("s_dailyLossLimitUsd").value) || undefined,
              maxPositionPct: parseFloat(el("s_maxPositionPct").value) || undefined,
              maxLeverage: parseFloat(el("s_maxLeverage").value) || undefined,
              allowPairs: parsePairs(el("s_allowPairs").value),
              blockPairs: parsePairs(el("s_blockPairs").value),
            };
            var paperPatch = {
              defaultCapital: parseFloat(el("s_defaultCapital").value) || undefined,
              slippageModel: el("s_slippageModel").value || undefined,
              constantSlippageBps: parseFloat(el("s_constantSlippageBps").value) || undefined,
              signalCheckIntervalSec: parseFloat(el("s_signalCheckIntervalSec").value) || undefined,
              us: { adapter: el("s_usAdapter").value },
              hk: { adapter: el("s_hkAdapter").value },
              cn: { adapter: el("s_cnAdapter").value },
            };
            Promise.all([
              SettingsBridge.patch("trading", tradingPatch),
              SettingsBridge.patch("paperTrading", paperPatch),
            ])
              .then(function () {
                toast("Settings saved", "success");
                closeSlide();
              })
              .catch(function (e) {
                toast("Save failed: " + e.message, "error");
              });
          },

          submitAlert: function () {
            var form = document.getElementById("alertForm");
            if (!form) return;
            var kind = form.querySelector("[name=alertKind]").value;
            var symbol = form.querySelector("[name=alertSymbol]").value.trim();
            var price = parseFloat(form.querySelector("[name=alertPrice]").value) || undefined;
            var threshold =
              parseFloat(form.querySelector("[name=alertThreshold]").value) || undefined;
            var direction = form.querySelector("[name=alertDirection]")
              ? form.querySelector("[name=alertDirection]").value
              : undefined;
            var msg = form.querySelector("[name=alertMsg]").value.trim() || undefined;

            apiPost("/api/v1/finance/alerts/create", {
              kind: kind,
              symbol: symbol || undefined,
              price: price,
              threshold: threshold,
              direction: direction,
              message: msg,
            })
              .then(function () {
                toast("Alert created", "success");
                closeSlide();
                fetchAlerts();
              })
              .catch(function (e) {
                toast(e.error || "Failed to create alert", "error");
              });
          },
        };

        // ════════════════════════════════════════════════════
        // SLIDE-OVER PANEL
        // ════════════════════════════════════════════════════

        window.openSlide = function (kind) {
          var bd = document.getElementById("slideBackdrop");
          var title = document.getElementById("slideTitle");
          var body = document.getElementById("slideBody");

          if (kind === "order") {
            title.textContent = "Place Order";
            body.innerHTML =
              '<form id="orderForm" onsubmit="event.preventDefault();CC.submitOrder()">' +
              '<div class="fg"><div class="bs-toggle">' +
              '<button type="button" class="bs-toggle__btn active-buy" onclick="setSide(this,\'buy\')">BUY</button>' +
              '<button type="button" class="bs-toggle__btn" onclick="setSide(this,\'sell\')">SELL</button>' +
              "</div></div>" +
              '<div class="fg"><label class="fg__label">Symbol</label><input name="symbol" placeholder="BTC/USDT" style="width:100%"></div>' +
              '<div class="fg"><div class="fg__row">' +
              '<div><label class="fg__label">Quantity</label><input name="quantity" type="number" step="any" placeholder="0.01" style="width:100%"></div>' +
              '<div><label class="fg__label">Price (est.)</label><input name="price" type="number" step="any" placeholder="Market" style="width:100%"></div>' +
              "</div></div>" +
              '<div class="fg"><label class="fg__label">Order Type</label><select name="orderType" style="width:100%"><option value="market">Market</option><option value="limit">Limit</option></select></div>' +
              '<button type="submit" class="submit-btn">Submit Order</button>' +
              "</form>";
          } else if (kind === "settings") {
            title.textContent = "Trading Settings";
            body.innerHTML =
              '<form id="settingsForm" class="settings-form" onsubmit="event.preventDefault();CC.saveSettings()">' +
              '<div class="settings-section"><div class="settings-section__title">Risk Controls</div>' +
              '<div class="fg"><label class="fg__label">Trading Enabled</label>' +
              '<label class="toggle-switch"><input type="checkbox" name="enabled" id="s_enabled"><span class="toggle-slider"></span></label></div>' +
              '<div class="fg"><label class="fg__label">Max Auto Trade (USD)</label><input name="maxAutoTradeUsd" id="s_maxAutoTradeUsd" type="number" step="any" style="width:100%"></div>' +
              '<div class="fg"><label class="fg__label">Confirmation Threshold (USD)</label><input name="confirmationThresholdUsd" id="s_confirmationThresholdUsd" type="number" step="any" style="width:100%"></div>' +
              '<div class="fg"><label class="fg__label">Daily Loss Limit (USD)</label><input name="dailyLossLimitUsd" id="s_dailyLossLimitUsd" type="number" step="any" style="width:100%"></div>' +
              '<div class="fg"><label class="fg__label">Max Position %</label><input name="maxPositionPct" id="s_maxPositionPct" type="number" step="any" style="width:100%"></div>' +
              '<div class="fg"><label class="fg__label">Max Leverage</label><input name="maxLeverage" id="s_maxLeverage" type="number" step="any" style="width:100%"></div>' +
              "</div>" +
              '<div class="settings-section"><div class="settings-section__title">Pair Filters</div>' +
              '<div class="fg"><label class="fg__label">Allowed Pairs (comma-separated)</label><input name="allowPairs" id="s_allowPairs" placeholder="BTC/USDT, ETH/USDT" style="width:100%"></div>' +
              '<div class="fg"><label class="fg__label">Blocked Pairs (comma-separated)</label><input name="blockPairs" id="s_blockPairs" placeholder="DOGE/USDT" style="width:100%"></div>' +
              "</div>" +
              '<details class="settings-details"><summary>Paper Trading Engine</summary>' +
              '<div class="fg"><label class="fg__label">Default Capital (USD)</label><input name="defaultCapital" id="s_defaultCapital" type="number" step="any" style="width:100%"></div>' +
              '<div class="fg"><label class="fg__label">Slippage Model</label><select name="slippageModel" id="s_slippageModel" style="width:100%"><option value="constant">Constant</option><option value="volume_share">Volume Share</option></select></div>' +
              '<div class="fg"><label class="fg__label">Slippage BPS</label><input name="constantSlippageBps" id="s_constantSlippageBps" type="number" step="any" style="width:100%"></div>' +
              '<div class="fg"><label class="fg__label">Signal Check Interval (sec)</label><input name="signalCheckIntervalSec" id="s_signalCheckIntervalSec" type="number" step="any" style="width:100%"></div>' +
              "</details>" +
              '<details class="settings-details"><summary>Market Adapters</summary>' +
              '<div class="fg"><label class="fg__label">US Adapter</label><select name="usAdapter" id="s_usAdapter" style="width:100%"><option value="alpaca">Alpaca</option><option value="none">None</option></select></div>' +
              '<div class="fg"><label class="fg__label">HK Adapter</label><select name="hkAdapter" id="s_hkAdapter" style="width:100%"><option value="futu">Futu</option><option value="none">None</option></select></div>' +
              '<div class="fg"><label class="fg__label">CN Adapter</label><select name="cnAdapter" id="s_cnAdapter" style="width:100%"><option value="openctp">OpenCTP</option><option value="tushare">Tushare</option><option value="none">None</option></select></div>' +
              "</details>" +
              '<button type="submit" class="submit-btn">Save Settings</button>' +
              "</form>";
            // Load current config values
            CC.loadSettings();
          } else if (kind === "alert") {
            title.textContent = "Set Alert";
            body.innerHTML =
              '<form id="alertForm" class="alert-form" onsubmit="event.preventDefault();CC.submitAlert()">' +
              '<div class="fg"><label class="fg__label">Alert Kind</label><select name="alertKind" style="width:100%">' +
              '<option value="price_above">Price Above</option>' +
              '<option value="price_below">Price Below</option>' +
              '<option value="pnl_threshold">PnL Threshold</option>' +
              "</select></div>" +
              '<div class="fg"><label class="fg__label">Symbol</label><input name="alertSymbol" placeholder="BTC/USDT" style="width:100%"></div>' +
              '<div class="fg"><div class="fg__row">' +
              '<div><label class="fg__label">Price</label><input name="alertPrice" type="number" step="any" placeholder="70000" style="width:100%"></div>' +
              '<div><label class="fg__label">Threshold ($)</label><input name="alertThreshold" type="number" step="any" placeholder="500" style="width:100%"></div>' +
              "</div></div>" +
              '<div class="fg"><label class="fg__label">Direction (PnL only)</label><select name="alertDirection" style="width:100%"><option value="loss">Loss</option><option value="gain">Gain</option></select></div>' +
              '<div class="fg"><label class="fg__label">Message</label><input name="alertMsg" placeholder="Optional note" style="width:100%"></div>' +
              '<button type="submit" class="submit-btn">Create Alert</button>' +
              "</form>";
          }

          bd.classList.add("open");
        };

        window.closeSlide = function () {
          document.getElementById("slideBackdrop").classList.remove("open");
        };

        window.setSide = function (btn, side) {
          var toggles = btn.parentElement.querySelectorAll(".bs-toggle__btn");
          for (var i = 0; i < toggles.length; i++) {
            toggles[i].className = "bs-toggle__btn";
          }
          btn.classList.add(side === "buy" ? "active-buy" : "active-sell");
        };

        window.filterFeed = function (filter, btn) {
          currentFilter = filter;
          var chips = document.querySelectorAll(".fchip");
          for (var i = 0; i < chips.length; i++) chips[i].classList.remove("active");
          btn.classList.add("active");
          renderFeed();
        };

        // ════════════════════════════════════════════════════
        // MODAL — Emergency Stop
        // ════════════════════════════════════════════════════

        document.getElementById("estopBtn").addEventListener("click", function () {
          document.getElementById("estopModal").classList.add("open");
        });

        window.closeModal = function (id) {
          document.getElementById(id).classList.remove("open");
        };

        document.getElementById("estopConfirm").addEventListener("click", function () {
          closeModal("estopModal");
          apiPost("/api/v1/finance/emergency-stop")
            .then(function (d) {
              toast("EMERGENCY STOP: " + d.message, "error");
              document.getElementById("riskHalo").classList.add("danger");
              document.getElementById("riskBadge").textContent = "STOPPED";
              document.getElementById("riskBadge").classList.add("danger");
              updateAiMsg("Emergency stop activated. All trading disabled.");
            })
            .catch(function (e) {
              toast(e.error || "Emergency stop failed", "error");
            });
        });

        // ════════════════════════════════════════════════════
        // BOTTOM BAR AI MESSAGE
        // ════════════════════════════════════════════════════

        function updateAiMsg(msg) {
          document.getElementById("aiMsg").innerHTML = "<em>" + esc(msg) + "</em>";
        }

        // ════════════════════════════════════════════════════
        // INITIALIZATION
        // ════════════════════════════════════════════════════

        // Render initial data if provided
        if (D.trading) renderTrading(D.trading);
        if (D.events) renderEvents(D.events);
        if (D.alerts) renderAlerts(D.alerts);

        // Connect SSE streams
        if (typeof EventSource !== "undefined") {
          connectTradingSSE();
          connectEventsSSE();
          updateAiMsg("Connected. Monitoring markets.");
        } else {
          updateAiMsg("SSE not supported. Dashboard is read-only.");
        }

        // Fetch alerts (no SSE stream for alerts)
        fetchAlerts();
        setInterval(fetchAlerts, 30000);
      })();
    </script>
  </body>
</html>

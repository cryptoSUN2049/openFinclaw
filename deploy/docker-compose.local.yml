# ==============================================================================
# OpenFinClaw - Local 开发环境 (PostgreSQL + Redis + Gateway)
# ==============================================================================
#
# Usage:
#   docker compose -f deploy/docker-compose.local.yml --env-file deploy/.env.local up -d --build
#
# 访问:
#   Gateway (WS + Control UI + WebChat):  http://localhost:18789
#   PostgreSQL:                           localhost:5434
#   Redis:                                localhost:6381
#
# ==============================================================================

name: finclaw-local

services:
  # ============================================================================
  # PostgreSQL 16 - 持久化存储 (轻量参数, macOS 本地开发)
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    container_name: finclaw-postgres-local
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5434}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-finclaw}
    volumes:
      - finclaw-local-postgres-data:/var/lib/postgresql/data
    command: >
      postgres
      -c max_connections=50
      -c shared_buffers=128MB
      -c effective_cache_size=256MB
      -c work_mem=16MB
      -c maintenance_work_mem=64MB
      -c wal_buffers=4MB
      -c checkpoint_completion_target=0.9
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - finclaw-local-network

  # ============================================================================
  # Redis 7 - 会话缓存 (256MB + LRU)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: finclaw-redis-local
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6381}:6379"
    volumes:
      - finclaw-local-redis-data:/data
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - finclaw-local-network

  # ============================================================================
  # OpenFinClaw Gateway - WebSocket 网关 + Control UI + WebChat
  # ============================================================================
  gateway:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.gateway
      args:
        - GATEWAY_AUTH_TOKEN=${GATEWAY_AUTH_TOKEN:-finclaw-local}
        - GATEWAY_ALLOWED_ORIGINS=${GATEWAY_ALLOWED_ORIGINS:-*}
        - GATEWAY_DEFAULT_MODEL=${GATEWAY_DEFAULT_MODEL:-litellm/moonshotai/kimi-k2.5}
        - VITE_SUPABASE_URL=${VITE_SUPABASE_URL:-}
        - VITE_SUPABASE_ANON_KEY=${VITE_SUPABASE_ANON_KEY:-}
        - VITE_GATEWAY_TOKEN=${GATEWAY_AUTH_TOKEN:-finclaw-local}
    container_name: finclaw-gateway-local
    restart: unless-stopped
    ports:
      - "${GATEWAY_PORT:-18789}:${GATEWAY_PORT:-18789}"
    depends_on:
      redis:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - GATEWAY_PORT=${GATEWAY_PORT:-18789}
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-finclaw}
      # LiteLLM Proxy
      - LITELLM_API_KEY=${LITELLM_API_KEY}
      - LITELLM_BASE_URL=${LITELLM_BASE_URL}
      # 渠道 Token (按需)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN:-}
      # Web Search (Brave / Perplexity / xAI / BrightData)
      - BRAVE_API_KEY=${BRAVE_API_KEY:-}
      - PERPLEXITY_API_KEY=${PERPLEXITY_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}
      - BRIGHTDATA_API_KEY=${BRIGHTDATA_API_KEY:-}
      - BRIGHTDATA_API_ENDPOINT=${BRIGHTDATA_API_ENDPOINT:-}
      - BRIGHTDATA_ZONE=${BRIGHTDATA_ZONE:-}
      # Gateway auth (config 中 ${GATEWAY_AUTH_TOKEN} 需要)
      - GATEWAY_AUTH_TOKEN=${GATEWAY_AUTH_TOKEN:-finclaw-local}
      # 金融功能 (默认启用)
      - OPENFINCLAW_FINANCE_ENABLED=${FINANCE_ENABLED:-true}
      - FINANCE_ENABLED=${FINANCE_ENABLED:-true}
      - FINANCE_API_URL=${FINANCE_API_URL:-}
      - FINANCE_SERVICE_TOKEN=${FINANCE_SERVICE_TOKEN:-}
      - LANGGRAPH_DIRECT_URL=${LANGGRAPH_DIRECT_URL:-}
      # 交易所 API
      - HYPERLIQUID_API_KEY=${HYPERLIQUID_API_KEY:-}
      - HYPERLIQUID_API_SECRET=${HYPERLIQUID_API_SECRET:-}
      - BINANCE_API_KEY=${BINANCE_API_KEY:-}
      - BINANCE_API_SECRET=${BINANCE_API_SECRET:-}
      - OKX_API_KEY=${OKX_API_KEY:-}
      - OKX_API_SECRET=${OKX_API_SECRET:-}
      - OKX_PASSPHRASE=${OKX_PASSPHRASE:-}
      # Finance auto-auth
      - FINANCE_AUTH_EMAIL=${FINANCE_AUTH_EMAIL:-}
      - FINANCE_AUTH_PASSWORD=${FINANCE_AUTH_PASSWORD:-}
      # 禁用代理 (容器内访问)
      - NO_PROXY=localhost,127.0.0.1,redis,postgres
      - HTTP_PROXY=
      - HTTPS_PROXY=
    volumes:
      - finclaw-local-state:/root/.openfinclaw
      # 挂载配置到临时路径, 启动时复制到 volume (避免 bind mount 阻止原子写入)
      - ./config/finclaw.local.json:/tmp/finclaw-config.json:ro
    command:
      [
        "sh",
        "-c",
        "cp /tmp/finclaw-config.json /root/.openfinclaw/openfinclaw.json && node dist/index.js gateway --bind lan --port $GATEWAY_PORT",
      ]
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -sf --connect-timeout 5 http://localhost:${GATEWAY_PORT:-18789}/ > /dev/null 2>&1 || [ $? -eq 22 ]",
        ]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    networks:
      - finclaw-local-network
      - finclaw-network

# ==============================================================================
# Volumes (持久化, 独立于 test 环境)
# ==============================================================================
volumes:
  finclaw-local-postgres-data:
    driver: local
  finclaw-local-redis-data:
    driver: local
  finclaw-local-state:
    driver: local

# ==============================================================================
# Networks
# ==============================================================================
networks:
  finclaw-local-network:
    driver: bridge
  finclaw-network:
    driver: bridge
    name: finclaw-network

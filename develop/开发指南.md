---
title: 开发环境搭建 & 编码规范
version: v0.1.0
module: guide
author: 全员
date: 2026-02-27
status: draft
---

# 开发环境搭建 & 编码规范

本文档涵盖 FinClaw Commons Hub 项目的开发环境配置、Git 工作流、项目结构、编码规范及调试技巧。

> **适用范围**：本指南主要适用于 **FinClaw Commons Hub Web 项目**（Next.js/Supabase 技术栈）。OpenFinClaw 金融扩展（`extensions/fin-*`）的开发请参考项目根目录的 `CLAUDE.md` 和 `FORK_DELTA.md`。

---

## 1. 环境搭建

### 1.1 Node.js >= 22

推荐使用版本管理工具安装：

```bash
# 使用 fnm（推荐）
fnm install 22
fnm use 22

# 或使用 nvm
nvm install 22
nvm use 22

# 验证
node -v  # >= v22.x
```

### 1.2 pnpm 包管理器

```bash
# 安装 pnpm
corepack enable
corepack prepare pnpm@latest --activate

# 或通过 npm 安装
npm install -g pnpm

# 验证
pnpm -v

# 安装项目依赖
pnpm install
```

### 1.3 Supabase CLI（本地开发）

```bash
# macOS
brew install supabase/tap/supabase

# 或通过 npm
npm install -g supabase

# 初始化本地 Supabase
supabase init
supabase start

# 验证
supabase status
```

### 1.4 Docker Desktop

从 [Docker 官网](https://www.docker.com/products/docker-desktop/) 下载安装 Docker Desktop。

```bash
# 验证
docker -v
docker compose version
```

### 1.5 VS Code 推荐插件

在 `.vscode/extensions.json` 中已配置推荐插件，打开项目时 VS Code 会自动提示安装：

| 插件                      | 用途                             |
| ------------------------- | -------------------------------- |
| ESLint                    | JavaScript / TypeScript 代码检查 |
| Tailwind CSS IntelliSense | Tailwind 类名自动补全            |
| Prettier                  | 代码格式化                       |
| i18n Ally                 | 国际化翻译管理                   |
| GitLens                   | Git 增强                         |
| Thunder Client            | API 调试                         |
| Docker                    | Docker 文件支持                  |
| Drizzle ORM               | 数据库 Schema 高亮               |

### 1.6 快速启动

```bash
# 克隆仓库
git clone https://github.com/<org>/finclaw-commons-hub.git
cd finclaw-commons-hub

# 安装依赖
pnpm install

# 配置环境变量
cp .env.example .env.local
# 编辑 .env.local 填入 Supabase 密钥等

# 启动开发服务器
pnpm dev
# → http://localhost:3000
```

---

## 2. Git 工作流

### 2.1 分支策略

```
main (production)
 └── dev (integration)
      ├── feat/arena-leaderboard
      ├── fix/auth-redirect
      └── chore/upgrade-deps
```

| 分支                           | 说明                                         | 保护规则                           |
| ------------------------------ | -------------------------------------------- | ---------------------------------- |
| `main`                         | 生产环境分支，只接受从 `dev` 的 Merge Commit | 必须 PR + 至少 1 Approve + CI 通过 |
| `dev`                          | 开发集成分支，所有功能分支合入此处           | 必须 PR + CI 通过                  |
| `feat/*` / `fix/*` / `chore/*` | 功能/修复/杂务分支，从 `dev` 拉取            | 无保护，开发者自行管理             |

### 2.2 Commit 规范

遵循 Conventional Commits，详见 [skill.md](./skill.md) 第 2 节。

### 2.3 PR 模板

创建 PR 时请填写以下模板：

```markdown
## 变更说明

<!-- 简要描述本次变更的内容和目的 -->

## 变更类型

- [ ] 新功能 (feat)
- [ ] Bug 修复 (fix)
- [ ] 重构 (refactor)
- [ ] 文档 (docs)
- [ ] 其他: \_\_\_

## 测试计划

<!-- 说明如何验证本次变更 -->

- [ ] 单元测试通过
- [ ] 本地手动测试通过
- [ ] 构建通过

## 截图 / 录屏

<!-- 如有 UI 变更请附截图 -->

## 关联 Issue

<!-- Closes #xxx -->
```

---

## 3. 项目结构说明

```
finclaw-commons-hub/
├── src/                      # 核心源码（TypeScript）
│   ├── app/                  # Next.js App Router 路由
│   │   ├── [locale]/         # i18n 动态路由
│   │   │   ├── auth/         # 认证页面（login, logout）
│   │   │   ├── arena/        # Arena 竞技场页面
│   │   │   ├── dashboard/    # 仪表盘（settings, entries, publish）
│   │   │   ├── entries/      # 技能浏览页
│   │   │   └── profile/      # 用户主页
│   │   ├── api/              # API Route Handlers
│   │   │   ├── arena/        # Arena API（submit, leaderboard, queue, evolution）
│   │   │   ├── auth/         # Auth API（session）
│   │   │   └── health/       # 健康检查
│   │   ├── auth/             # Auth Callback（非 locale 路由）
│   │   ├── layout.tsx        # 根 Layout
│   │   └── page.tsx          # 根页面
│   ├── server/               # 服务端逻辑
│   │   ├── auth/             # Supabase JWT 验证
│   │   ├── arena/            # Arena HTTP 客户端代理
│   │   └── entries/          # 技能注册服务
│   ├── components/           # React 组件
│   │   ├── ui/               # 基础 UI 组件（shadcn-ui: button, card, badge...）
│   │   ├── layout/           # 布局组件（header, user-nav）
│   │   ├── entries/          # 技能相关组件
│   │   ├── theme/            # 主题组件（provider, script, switcher）
│   │   └── i18n/             # 国际化组件（language-switcher）
│   ├── lib/                  # 共享工具库
│   │   ├── supabase/         # Supabase 客户端封装（client / server）
│   │   └── utils.ts          # 通用工具函数
│   ├── i18n/                 # i18n 配置（next-intl request）
│   └── env.ts                # 环境变量类型定义
├── messages/                 # i18n 翻译文件
│   ├── en.json               # 英文
│   └── zh-CN.json            # 简体中文
├── sql/                      # 数据库 Schema & 迁移
│   ├── init/                 # 初始化脚本
│   └── migration/            # 迁移脚本
├── data/                     # 运行时数据（Registry、FCS、Arena）
├── design/                   # 架构设计文档
│   ├── 架构设计/             # 产品概述、模块架构、业务流程、技术设计、数据库 Schema
│   └── 模版/                 # 设计模版
├── develop/                  # 开发文档（本目录）
├── docs/                     # 产品设计、战略规划、技术文档、竞品分析
├── deploy/                   # 部署配置（Docker、脚本）
├── public/                   # 静态资源
├── old/                      # 旧版代码（Astro 5 迁移前）
├── .vscode/                  # VS Code 配置
├── Dockerfile                # Docker 镜像构建
├── docker-compose.next.yml   # Docker Compose 配置
├── next.config.ts            # Next.js 配置
├── tsconfig.json             # TypeScript 配置
├── eslint.config.mjs         # ESLint 配置
├── postcss.config.mjs        # PostCSS 配置（Tailwind v4）
└── package.json              # 项目依赖 & 脚本
```

### 目录职责一览

| 目录              | 职责                          | 关键技术                         |
| ----------------- | ----------------------------- | -------------------------------- |
| `src/app/`        | Next.js App Router 路由 & API | Next.js 16, React 19             |
| `src/server/`     | 仅服务端运行的业务逻辑        | Node.js, jose                    |
| `src/components/` | UI 组件                       | React 19, shadcn-ui, Tailwind v4 |
| `src/lib/`        | 前后端共享的工具              | Supabase, Zod                    |
| `sql/`            | 数据库管理                    | PostgreSQL, Drizzle ORM          |
| `messages/`       | i18n 翻译                     | next-intl                        |

---

## 4. 编码规范

### 4.1 TypeScript

- 启用 **strict mode**，不允许 `any`（如确实需要请使用 `unknown` + 类型守卫）。
- 使用 [Zod](https://zod.dev/) 进行运行时数据校验，特别是 API 输入。
- 优先使用 `interface` 定义对象类型，`type` 用于联合类型和工具类型。
- 函数返回类型显式声明（公共 API 函数）。

```typescript
// Good
import { z } from "zod";

const SubmitSchema = z.object({
  entryId: z.string().uuid(),
  scenario: z.enum(["bull", "bear", "sideways", "volatile", "crash", "recovery"]),
});

export async function submitArena(input: z.infer<typeof SubmitSchema>): Promise<ArenaResult> {
  const validated = SubmitSchema.parse(input);
  // ...
}

// Bad
export async function submitArena(input: any) {
  // ...
}
```

### 4.2 React

- **函数组件 + Hooks**，不使用 class 组件。
- **Server Components 优先** —— 只有需要交互（事件处理、useState/useEffect）的组件才标记 `'use client'`。
- 组件 Props 使用 `interface` 定义，不使用 `React.FC`。

```typescript
// Good - Server Component (default)
interface EntryCardProps {
  entry: Entry;
  showScore?: boolean;
}

export function EntryCard({ entry, showScore = true }: EntryCardProps) {
  return (
    <div className="rounded-lg border p-4">
      <h3>{entry.name}</h3>
      {showScore && <span>{entry.fcsScore}</span>}
    </div>
  );
}

// Client Component - only when needed
'use client';

export function ArenaClient() {
  const [scenario, setScenario] = useState<Scenario>('bull');
  // ...
}
```

### 4.3 CSS / Tailwind

- 使用 **Tailwind v4**，通过设计 token（CSS 变量）保持视觉一致性。
- 避免内联 `style`，所有样式通过 Tailwind class 实现。
- 使用 `cn()` 工具函数合并 class（基于 `clsx` + `tailwind-merge`）。
- 响应式设计使用 Tailwind 断点：`sm:`, `md:`, `lg:`, `xl:`。

```typescript
import { cn } from '@/lib/utils';

<div className={cn(
  "rounded-lg border p-4",
  isActive && "border-primary bg-primary/10",
  className
)} />
```

### 4.4 文件命名

- **文件 & 目录**：`kebab-case`（如 `arena-client.tsx`, `fcs-scoring.ts`）
- **React 组件**：文件名 `kebab-case`，导出名 `PascalCase`（如 `entry-card.tsx` → `export function EntryCard`）
- **类型文件**：`<module>.types.ts` 或直接在模块文件中定义
- **测试文件**：`<module>.test.ts` / `<module>.test.tsx`
- **API Route**：`route.ts`（Next.js App Router 约定）

### 4.5 导入排序

推荐按以下顺序组织 import：

```typescript
// 1. Node.js 内置模块
import { readFile } from "node:fs/promises";

// 2. 第三方依赖
import { z } from "zod";
import { NextResponse } from "next/server";

// 3. 项目内部模块（使用路径别名 @/）
import { createClient } from "@/lib/supabase/server";
import { EntryCard } from "@/components/entries/entry-card";

// 4. 类型导入
import type { Entry } from "@/types";
```

---

## 5. 调试技巧

### 5.1 Next.js 开发服务器调试

```bash
# 启动开发服务器（带热更新）
pnpm dev

# 启动 Node.js Inspector（支持 Chrome DevTools 调试）
NODE_OPTIONS='--inspect' pnpm dev
# 打开 chrome://inspect 连接调试
```

**常见问题排查**：

| 问题                  | 排查方向                                                  |
| --------------------- | --------------------------------------------------------- |
| 页面 404              | 检查 `src/app/` 路由文件命名是否正确                      |
| Server Component 报错 | 确认没有在 Server Component 中使用 `useState`/`useEffect` |
| 环境变量未生效        | 检查 `.env.local` 和 `NEXT_PUBLIC_` 前缀                  |
| 样式不生效            | 确认 Tailwind 配置包含了目标文件路径                      |

### 5.2 Supabase 本地调试

```bash
# 查看本地 Supabase 状态
supabase status

# 查看实时日志
supabase logs

# 访问本地 Supabase Studio
# 默认地址：http://localhost:54323

# 重置本地数据库
supabase db reset
```

### 5.3 数据库查询调试

```bash
# 使用 Drizzle Studio 可视化查看数据
pnpm drizzle-kit studio

# 生成迁移
pnpm drizzle-kit generate

# 执行迁移
pnpm drizzle-kit migrate

# 直接连接 PostgreSQL
psql $DATABASE_URL
```

**Drizzle ORM 调试技巧**：

```typescript
import { sql } from "drizzle-orm";

// 打印生成的 SQL（开发环境）
const query = db.select().from(entries).where(eq(entries.status, "active"));
console.log(query.toSQL()); // 查看生成的 SQL 语句
```

### 5.4 API 调试

```bash
# 健康检查
curl http://localhost:3000/api/health

# Arena 排行榜
curl http://localhost:3000/api/arena/leaderboard

# 带认证的请求
curl -H "Authorization: Bearer <token>" \
  http://localhost:3000/api/arena/submit
```

推荐使用 VS Code 的 **Thunder Client** 或 **REST Client** 插件进行 API 调试，支持保存请求集合和环境变量。

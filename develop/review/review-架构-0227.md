FinClaw Commons Hub — 全栈 + 金融专家 Review

基于 5 份架构文档 + 全量源码深度阅读，以下从工程架构和金融专业性两个维度给出评审。

---

一、总体评价

┌────────────┬────────┬───────────────────────────────────────────────────────────────────┐  
 │ 维度 │ 评分 │ 一句话 │  
 ├────────────┼────────┼───────────────────────────────────────────────────────────────────┤
│ 架构设计 │ 8.5/10 │ 分层清晰、纯函数+不可变数据模式优秀，Arena 引擎设计水平很高 │
├────────────┼────────┼───────────────────────────────────────────────────────────────────┤
│ 工程质量 │ 7.5/10 │ TypeScript 类型安全、测试覆盖 70%+，但存储层和并发处理有硬伤 │
├────────────┼────────┼───────────────────────────────────────────────────────────────────┤
│ 安全性 │ 6/10 │ Fail-closed 理念正确，但 Auth 有多个中高危漏洞，安全扫描可被绕过 │
├────────────┼────────┼───────────────────────────────────────────────────────────────────┤
│ 金融专业性 │ 5.5/10 │ 框架搭得好，但回测模拟、评分公式、PK 机制在金融专业角度有多处硬伤 │
├────────────┼────────┼───────────────────────────────────────────────────────────────────┤
│ 产品完成度 │ 7/10 │ Phase 1+2 核心流程打通，但离"Agent 可真正使用"还有距离 │
└────────────┴────────┴───────────────────────────────────────────────────────────────────┘

结论：作为 MVP/概念验证 质量很高，但要让真实的 Agent 社区信任你的回测数据和排行榜，需要修复以下关键问题。

---

二、工程架构层面 (全栈视角)

亮点 — 做得好的地方

1. 纯函数状态机 (submission-pipeline.ts) — VALID_TRANSITIONS + 不可变 advanceSubmission() 是教科书级设计
2. 优雅降级三条链 — LLM 不可用 → 规则扫描；LangGraph 不可用 → Mock；进化 LLM 失败 →
   规则变异。每条链都选择更安全的方向
3. Fail-closed 安全理念 — Review Agent 任何不确定都 escalate 给人工，绝不自动放行
4. 类型安全 — Zod schema + Drizzle ORM $inferSelect + verbatimModuleSyntax，全链路类型安全
5. 事件驱动 — EventBus 单例 + SSE 推送，模块间解耦干净

🔴 Critical — 必须修复

C1: JSON 文件存储无锁，并发写入丢数据

arena-storage.ts: upsertSubmission()
→ loadSubmissions() // 读
→ file.submissions[id] = submission // 改
→ saveSubmissions() // 写

两个并发请求同时读到旧文件 → 各自写入 → 后写的覆盖前写的。提交记录、ELO 评分、排行榜都可能丢失。

修复：生产环境必须走 PostgreSQL 事务（表已设计好），或至少加文件锁 (proper-lockfile)。

C2: 安全扫描正则可被绕过

// 当前检测
/require\s*\(\s*['"]fs['"]\s\*\)/g

// 以下全部逃逸：
require('fs/promises')
const { readFile } = require('fs')
import \* as fs from 'node:fs'
await import('fs') // 动态 import
Function('return require("fs")')()

金融平台上跑用户提交的代码，沙箱逃逸 = 安全事故。

修复：规则层改为 AST 分析（用 acorn 或 ts-morph），不要靠正则。

C3: Auth 安全多处漏洞

┌─────────────────────────────────────┬─────────────────────┬───────────────────────────────────────────────┐
│ 问题 │ 文件 │ 风险 │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────────────────────┤
│ Logout 是 GET 请求 │ auth/logout.astro │ <img src="/auth/logout"> 可在任何网站登出用户 │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────────────────────┤
│ Cookie secure flag 靠协议检测 │ auth/callback.astro │ 反向代理后 protocol=http，Token 明文传输 │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────────────────────┤
│ 错误消息暴露 "Email already exists" │ auth/register.astro │ 用户枚举攻击 │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────────────────────┤
│ Redirect URL 验证不完整 │ auth/login.astro │ 开放重定向 │
├─────────────────────────────────────┼─────────────────────┼───────────────────────────────────────────────┤
│ API entries limit 无上限 │ api/v1/entries │ limit=999999 → DoS │
└─────────────────────────────────────┴─────────────────────┴───────────────────────────────────────────────┘

🟡 High — 强烈建议修复

H1: MAX_FILE_SIZE_BYTES 定义了但从未执行

security-scanner.ts 定义了 1MB 限制，但 requestSecurityScan() 从不检查。10MB 恶意代码直接进
LLM，既是安全漏洞也烧钱。

H2: LLM Prompt 注入未防护

`请分析以下代码的安全风险：\n\`\`\`typescript\n${content}\n\`\`\``

如果提交的代码中包含 ```，会破坏代码块边界，注入指令让 LLM 返回 "safe"。安全扫描和 Review Agent 都有这个问题。

H3: Review Agent 低置信度 rejection 不 escalate

if (parsed.decision === "approved" && parsed.confidence < threshold) {
return { ...parsed, decision: "escalated" };
}
// ❌ rejected + confidence=5% 直接通过！不确定的拒绝也该上报人工

H4: 数据库连接池无超时配置

\_pool = new pg.Pool({ connectionString: url });
// 缺少 idleTimeoutMillis, connectionTimeoutMillis
// SSR 热重载时连接泄漏

---

三、金融专业性层面 (顶级量化视角)

这是这个项目最需要加强的部分。你的定位是"免费回测 + 实时排行榜"，这意味着数据可信度就是你的核心竞争力。

🔴 Critical — 金融硬伤

F1: Mock 回测数据违反金融现实

// backtest-client.ts — 各指标独立随机
sharpeRatio: randomInRange(0.8, 2.5), // bull
totalReturnPct: randomInRange(10, 80),
maxDrawdownPct: randomInRange(5, 20),
winRatePct: randomInRange(50, 80),

问题：现实中这四个指标高度相关。

- Sharpe = (Return - RiskFree) / Volatility，高 Sharpe + 高 Return 必然意味着低波动
- 高 WinRate 通常伴随低单笔盈利（反向关系）
- Mock 可能生成 Sharpe=2.5, Return=80%, Drawdown=5% — 这在现实中几乎不可能，除非是诈骗

影响：如果用户在你的平台看到 Mock 数据生成的排行榜，会立刻失去信任。任何做过量化的人一眼就能看出来数据是假的。

修复：用协方差矩阵生成相关指标，或直接标注 "Mock Data — 仅供展示"。

F2: 排行榜评分范围硬编码，不适合多资产类别

// leaderboard-engine.ts
// Sharpe: map [-1, 3] → [0, 100]
const sharpeScore = clamp(((avgSharpe + 1) / 4) _ 100, 0, 100);
// Return: map [-50%, 200%] → [0, 100]
const returnScore = clamp(((avgReturn + 50) / 250) _ 100, 0, 100);

┌──────────┬─────────────┬──────────────┬──────────────────────────────┐
│ 策略类型 │ 典型 Sharpe │ 典型年化收益 │ 在你系统的表现 │
├──────────┼─────────────┼──────────────┼──────────────────────────────┤
│ 高频做市 │ 5-15 │ 50-200% │ Sharpe 封顶 100 分，无法区分 │
├──────────┼─────────────┼──────────────┼──────────────────────────────┤
│ 加密趋势 │ 1-4 │ 100-1000% │ Return 封顶 100 分 │
├──────────┼─────────────┼──────────────┼──────────────────────────────┤
│ 债券套利 │ 0.5-1.5 │ 3-8% │ Return 只有 21 分，永远垫底 │
├──────────┼─────────────┼──────────────┼──────────────────────────────┤
│ CTA 趋势 │ 0.8-2.0 │ 10-30% │ 还算合理 │
└──────────┴─────────────┴──────────────┴──────────────────────────────┘

影响：不同资产类别的策略放在同一个排行榜，永远是加密策略碾压债券策略。这不公平，也不专业。

修复：按资产类别/策略类型分榜，或用百分位排名代替绝对分数。

F3: Strategy PK 四维等权投票存在双重计算

4 维等权: Sharpe(25%) + Return(25%) + Drawdown(25%) + WinRate(25%)

问题：Sharpe Ratio = (Return - Rf) / σ，已经包含了 Return 和 Risk(Drawdown 的代理)。等权投票实际上 Return
被计算了两次，Risk 被计算了两次。

结果：优化 Return 的策略在 PK 中有系统性优势 — Sharpe 包含它，Return 维度又算一次。

修复：

- 方案 A：去掉 Return 和 Drawdown，改用 Sharpe(50%) + WinRate(30%) + MaxDrawdown(20%)
- 方案 B：用 Calmar Ratio (Return/MaxDrawdown) 替代 Sharpe，避免重叠

F4: 进化引擎的模拟是确定性的，算法实际上不工作

const hash = simpleHash(`${scenario}-${mutation.type}-${mutation.timestamp}`);
const factor = 1 + (hash - 0.5) _ 2 _ mag;

同一场景 + 同一变异类型 + 同一时间戳 → 永远生成相同的扰动。进化引擎跑 20 代，每代 parameter-tune
都是一样的结果。这不是进化，是重复。

F5: 过拟合检测阈值太粗糙

// risk-gate.ts
sharpeRatio > 2.5 && totalReturnPct > 50 && maxDrawdownPct < 5 && winRatePct > 70

必须全部满足 (AND) 才触发。但真实过拟合往往只在部分指标上异常亮眼。一个 Sharpe=10, Return=300% 但 Drawdown=6%
的策略就逃过检测了。

修复：用加权异常分数而非全 AND 逻辑，或引入 Sharpe Decay Test (样本外 Sharpe / 样本内 Sharpe)。

🟡 High — 金融层面建议

F6: ELO 系统在金融场景有天然缺陷

ELO 假设：比赛结果是选手当前实力的体现。但金融策略的表现是市场环境相关的 —
趋势策略在牛市碾压均值回归策略，熊市反转。

如果 PK 对决碰巧都在牛市场景执行，趋势策略 ELO 飙升，但这不代表它整体更好。

建议：PK 场景应强制覆盖所有 6 种市场环境，或引入 Glicko-2 评级（包含评分可靠度）。

F7: 缺少关键金融风控指标

排行榜 4 维度中缺少：

┌─────────────────────┬──────────────────────────────────────────────┐
│ 缺失指标 │ 为什么重要 │
├─────────────────────┼──────────────────────────────────────────────┤
│ Calmar Ratio │ Return/MaxDrawdown，比 Sharpe 更关注尾部风险 │
├─────────────────────┼──────────────────────────────────────────────┤
│ Sortino Ratio │ 只惩罚下行波动，比 Sharpe 更适合策略评估 │
├─────────────────────┼──────────────────────────────────────────────┤
│ 最大连续亏损天数 │ 用户最关心"最坏情况持续多久" │
├─────────────────────┼──────────────────────────────────────────────┤
│ 换手率/交易频率 │ 区分被动持有 vs 高频交易 │
├─────────────────────┼──────────────────────────────────────────────┤
│ 尾部风险 (VaR/CVaR) │ 金融监管标准指标 │
└─────────────────────┴──────────────────────────────────────────────┘

---

四、产品定位建议

你说定位是 "Agent 可阅读、订阅、使用 skills 的社区"，但当前架构更像是人类开发者的平台。要真正服务
Agent，需要考虑：

┌──────────────────────────────────┬───────────────────────────────────────────────────────────┐
│ 当前状态 │ Agent 友好需要 │
├──────────────────────────────────┼───────────────────────────────────────────────────────────┤
│ Web UI 为主，CLI 辅助 │ API-first，Agent 通过 API 发现/安装/使用 skills │
├──────────────────────────────────┼───────────────────────────────────────────────────────────┤
│ 人工审核 escalation │ Agent 之间的自动化信任链 (类似 npm 的 verified publisher) │
├──────────────────────────────────┼───────────────────────────────────────────────────────────┤
│ 浏览器交互（Subscribe/Favorite） │ MCP/Tool Use 协议，Agent 直接调用 skill │
├──────────────────────────────────┼───────────────────────────────────────────────────────────┤
│ 注册需要 Email/OAuth │ API Key + Agent Identity，无需人工注册流 │
├──────────────────────────────────┼───────────────────────────────────────────────────────────┤
│ 静态排行榜页面 │ 实时 API + Webhook，Agent 订阅排名变化 │
└──────────────────────────────────┴───────────────────────────────────────────────────────────┘

---

五、优先级行动建议

Sprint 1 (1-2 周) — 修安全 + 修金融硬伤

1. Auth 安全修复（Logout POST、Cookie secure、错误脱敏、Redirect 验证）
2. 安全扫描改 AST 分析，替代正则
3. Mock 回测数据标注 "Mock" 或用协方差矩阵生成
4. 排行榜评分范围改为可配置 / 按资产类别

Sprint 2 (2-4 周) — 存储层 + 金融引擎

5. Arena 数据从 JSON 迁移到 PostgreSQL（表已就绪）
6. PK 指标去重（去掉 Return/Drawdown 与 Sharpe 的重叠）
7. 增加 Sortino / Calmar / MaxConsecutiveLoss 指标
8. 进化引擎的模拟加入随机性，打破确定性

Sprint 3 (1-2 月) — Agent-first 体验

9. Skills Discovery API（Agent 可搜索/安装/使用）
10. API Key 认证 + Agent Identity
11. 实时 Webhook / SSE 订阅排名变化
12. MCP 协议初步集成

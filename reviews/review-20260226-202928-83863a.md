# Consolidated Code Review - 2026-02-26

## Findings

### 1) AGENTS instructions conflict with fork identity

- File path and line number: `AGENTS.md:3`, `AGENTS.md:47-52`, `AGENTS.md:62-63`, `AGENTS.md:83`; `package.json:2`, `package.json:24-26`, `package.json:110-111`
- Severity: **critical**
- Category: **Holistic**
- Description: Root agent guidance is upstream-centric (`openclaw/openclaw`, `openclaw` CLI) while this fork uses `openfinclaw`. This can misroute agent workflows, issue triage, and release/security operations.
- Suggested fix: Create a fork-specific root `AGENTS.md` baseline (repo URLs, CLI commands, release targets) and isolate upstream-only guidance in an explicit "upstream reference" section.

### 2) `default(...).optional()` pattern prevents intended Zod defaults

- File path and line number: `src/config/zod-schema.financial.ts:57` (also `73-79`, `85-89`, `94-100`, `106-136`)
- Severity: **high**
- Category: **Diff**
- Description: New schema fields chain `.default(...).optional()`. In Zod, this pattern can allow `undefined` to bypass default application, causing runtime config values to miss documented defaults.
- Suggested fix: Remove trailing `.optional()` where defaults are intended, or apply object-level preprocessing/defaulting so omitted fields resolve deterministically.

### 3) Repository authority/metadata points to multiple different repos

- File path and line number: `README.md:239`; `CONTRIBUTING.md:1`, `CONTRIBUTING.md:7`, `CONTRIBUTING.md:56`; `package.json:16-23`
- Severity: **high**
- Category: **Holistic**
- Description: README, CONTRIBUTING, and `package.json` reference different org/repo authorities. This creates contributor confusion and can break automation for bugs/releases.
- Suggested fix: Choose one canonical org/repo and align all metadata/docs; keep any upstream links in a clearly marked reference section.

### 4) Oversized core modules reduce maintainability and reviewability

- File path and line number: `src/memory/qmd-manager.ts` (~1900 LOC), `src/discord/monitor/agent-components.ts` (~1729 LOC), `src/commands/doctor-config-flow.ts` (~1637 LOC), `src/telegram/bot-handlers.ts` (~1406 LOC)
- Severity: **high**
- Category: **Holistic**
- Description: Several core modules are very large, increasing onboarding cost, regression risk, and agent-edit complexity.
- Suggested fix: Split by responsibility boundaries (transport/parsing/policy/IO/formatting), keep thin entrypoint facades, and route new logic into extracted modules.

### 5) Tracked local env file contains hardcoded remote HTTP endpoint

- File path and line number: `ui/.env.local:1`
- Severity: **medium**
- Category: **Diff**
- Description: A local env file is tracked with a hardcoded remote endpoint over HTTP. This can leak environment details and introduce unsafe defaults for developers.
- Suggested fix: Remove `ui/.env.local` from version control, add it to `.gitignore`, and provide placeholder defaults in `.env.example`.

### 6) New UI tests are not in default Vitest include set

- File path and line number: `vitest.config.ts:40`
- Severity: **medium**
- Category: **Diff**
- Description: Added UI tests are not covered by the root Vitest include list, so they may not run in default test workflows.
- Suggested fix: Expand `test.include` to cover these files (or enforce a dedicated UI test command in CI).

### 7) AGENTS/CLAUDE symlink rule is inconsistently applied

- File path and line number: `docs/ja-JP/`, `docs/zh-CN/`, `docs/reference/templates/` (rule source: `AGENTS.md:164`)
- Severity: **medium**
- Category: **Holistic**
- Description: Some directories with `AGENTS.md` do not have matching `CLAUDE.md` symlinks despite stated policy.
- Suggested fix: Add `CLAUDE.md -> AGENTS.md` symlinks where required, or narrow the policy language to intended directories only.

### 8) LOC guard exists but is not enforced in primary quality gate

- File path and line number: `package.json:65`, `package.json:67`; `.github/workflows/ci.yml`
- Severity: **medium**
- Category: **Holistic**
- Description: `check:loc` exists but is not part of default `check` and CI path, reducing enforcement of file-size guardrails.
- Suggested fix: Add `check:loc` to `pnpm check` or enforce it as a required CI job.

### 9) Missing canonical finance architecture documentation

- File path and line number: `README.md`, `docs/`
- Severity: **medium**
- Category: **Holistic**
- Description: Finance architecture appears across roadmap/diagram text, but there is no canonical architecture doc clarifying implemented state vs planned state.
- Suggested fix: Add a dedicated doc (e.g., `docs/architecture/financial-layer.md`) with clear current-state boundaries, roadmap sections, and ownership.

### 10) New financial config surface lacks focused schema tests

- File path and line number: `src/config/zod-schema.financial.ts:51`
- Severity: **low**
- Category: **Diff**
- Description: Significant new config surface was added without corresponding targeted schema tests for defaults, bounds, and reject paths.
- Suggested fix: Add unit tests for valid parsing, boundary failures, default application, and sensitive-field handling.

## Summary

- Total issues: **10**
- Severity breakdown: **1 critical**, **3 high**, **5 medium**, **1 low**
- Agents that ran: **Diff Review Agent**, **Holistic Review Agent**
- Overall assessment: Recent changes introduce at least one high-impact correctness risk (Zod defaults) and test-execution gaps; repo-level maintainability/agent-readiness is constrained by instruction drift and structural/documentation inconsistencies.
